[{"rule_id": 12, "name": "MSCAP - The name of an account was changed EventCode=4781 RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - The name of an account was changed EventCode=4781 RAW (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 06/June/2024\r\n\r\ndatamodel dataset = microsoft_windows_raw \r\n|alter \r\n    oldtargetusername=json_extract_scalar(microsoft_windows_raw.event_data,\"$.OldTargetUserName\"),\r\n    newtargetusername=json_extract_scalar(microsoft_windows_raw.event_data,\"$.NewTargetUserName\"),\r\n    samaccountname=json_extract_scalar(microsoft_windows_raw.event_data,\"$.SamAccountName\")\r\n//| alter samaccountname=if(array_length(samaccountname) > 1, arrayindex(samaccountname, 1), samaccountname) \r\n|filter xdm.event.id = \"4781\" and oldtargetusername=\"*$\" and newtargetusername != \"*$\"\r\n|comp values(microsoft_windows_raw._raw_log), earliest(_time) as first_time, latest(_time) as last_time, values(oldtargetusername) as oldtargetusername, values(newtargetusername) as newtargetusername, values(samaccountname) as samaccountname, values(xdm.source.user.username) as user, values(_vendor) as vendor, values(_product) as product, values(xdm.observer.name) as orig_host by xdm.target.ipv4,xdm.event.id ", "is_enabled": true, "description": "Rule 30", "alert_name": "\"MSCAP - The name of an account was changed EventCode=4781 RAW (CCX) - Summary Gen", "alert_category": "EVASION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "vendor", "eventid": "xdm.event.id", "_product": "product", "targetip": "xdm.target.ipv4", "originalhost": "orig_host", "lasteventtime": "last_time", "firsteventtime": "first_time", "samaccountname": "samaccountname", "newtargetusername": "newtargetusername", "oldtargetusername": "oldtargetusername", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["newtargetusername", "oldtargetusername", "orig_host", "user", "xdm.event.id", "xdm.target.ipv4"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0005 - Defense Evasion": ["T1036.005 - Masquerading: Match Legitimate Name or Location"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 13, "name": "MSCAP - New Windows Account EventCode=4741 RAW (CCX) - Summary", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - New Windows Account EventCode=4741 RAW (CCX) - Summary Gen\n/// Author: Deven Amode, damode@paloaltonetworks.com\n// Datasets: microsoft_windows_raw \n// Date: 06/June/2024\n\ndatamodel dataset = microsoft_windows_raw \n|alter samaccountname=json_extract_scalar(microsoft_windows_raw.event_data,\"$.SamAccountName\")\n//| alter samaccountname=if(array_length(samaccountname) > 1, arrayindex(samaccountname, 1), samaccountname) \n|filter xdm.event.id = \"4741\" and samaccountname = \"*$\"\n| filter xdm.source.user.username != \"priv.*\"\n| replacenull xdm.source.user.username = \"missing\", samaccountname = \"missing\"\n|comp values(microsoft_windows_raw._raw_log), earliest(_time) as first_time, latest(_time) as last_time, values(_vendor) as vendor, values(_product) as product, values(xdm.observer.name) as orig_host by xdm.target.ipv4,xdm.event.id,xdm.source.user.username,samaccountname, xdm.event.description ", "is_enabled": true, "description": "Rule 29", "alert_name": "MSCAP - New Windows Account EventCode=4741 RAW (CCX) - Summary", "alert_category": "EVASION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "vendor", "eventid": "xdm.event.id", "_product": "product", "targetip": "xdm.target.ipv4", "originalhost": "orig_host", "lasteventtime": "last_time", "firsteventtime": "first_time", "samaccountname": "samaccountname", "actor_effective_username": "xdm.source.user.username"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["samaccountname", "xdm.event.id", "xdm.target.ipv4", "orig_host", "xdm.source.user.username"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0005 - Defense Evasion": ["T1036.005 - Masquerading: Match Legitimate Name or Location"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 14, "name": "MSCAP - Windows Computer Account With SPN RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": " datamodel dataset = microsoft_windows_raw \r\n \r\n |alter \r\n    serviceprincipalnames=json_extract_scalar(microsoft_windows_raw.event_data,\"$.ServicePrincipalNames\"),\r\n    newuacvalue=json_extract_scalar(microsoft_windows_raw.event_data,\"$.NewUacValue\"),\r\n    targetsid=json_extract_scalar(microsoft_windows_raw.event_data,\"$.targetsid\"),\r\n    dnshostname=json_extract_scalar(microsoft_windows_raw.event_data,\"$.DnsHostName\")\r\n\r\n| filter xdm.event.id =\"4741\" and serviceprincipalnames in (\"*host/*\", \"*restrictedkrbhost/*\") and newuacvalue=\"0x80\"\r\n\r\n|comp values(_vendor) as vendor , values(_product) as vendor_product , values(xdm.observer.type) as orig_sourcetype , values(xdm.source.host.hostname) as orig_host , values(microsoft_windows_raw._raw_log ) as orig_raw, min(_time) as first_event_time, max(_time) as last_event_time , values(xdm.event.id) as eventcode , values(xdm.target.user.domain) as targetdomainname , values(targetsid) as targetsid , values(xdm.source.user.username) as user , values(xdm.source.ipv4) as src , values(dnshostname) as dnshostname , values(serviceprincipalnames) as serviceprincipalnames by xdm.target.ipv4, xdm.source.user.identifier  \r\n\r\n", "is_enabled": true, "description": "Rule 32", "alert_name": "MSCAP - Windows Computer Account With SPN RAW (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "dnshostname", "source": "src", "_vendor": "vendor", "targetip": "xdm.target.ipv4", "eventcode": "eventcode", "targetsid": "targetsid", "sourceuserid": "xdm.source.user.identifier", "targetdomain": "targetdomainname", "lasteventtime": "last_event_time", "vendorproduct": "vendor_product", "firsteventtime": "first_event_time", "originalsourcetype": "orig_sourcetype", "serviceprincipalnames": "serviceprincipalnames", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["eventcode", "targetdomainname", "targetsid", "user", "src", "xdm.source.user.identifier"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1558 - Steal or Forge Kerberos Tickets"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 15, "name": "MSCAP - Windows Server Defence Evasion Codes to Monitor RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": " // Title: MSCAP - Windows Server Defence Evasion Codes to Monitor RAW (CCX) - Summary Gen\r\n/// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Datasets: microsoft_windows_raw \r\n// Date: 07/June/2024\r\n\r\ndatamodel dataset = microsoft_windows_raw\r\n\r\n|alter\r\n    Category = arrayindex(regextract(microsoft_windows_raw.message, \"Category:\\s*(.+?)\\s+\\w+:\"),0 ),\r\n    Subcategory = arrayindex(regextract(microsoft_windows_raw.message, \"Subcategory:\\s*(.+)\"),0 ),\r\n    Changes = arrayindex(regextract(microsoft_windows_raw.message, \"Changes:\\s*(.+)\"),0 )\r\n \r\n| filter xdm.event.id =\"4719\"\r\n| filter xdm.source.user.username != \"*$\"\r\n\r\n|comp  \r\n    min(_time) as first_event_time,\r\n    max(_time) as last_event_time,\r\n    values(xdm.event.id) as eventcode,  \r\n    values(xdm.source.ipv4) as src ,\r\n    values(xdm.observer.type) as orig_sourcetype ,    \r\n    values(Changes) as Changes\r\n    by xdm.source.user.username, xdm.source.host.hostname, _vendor, _product, Category , Subcategory ", "is_enabled": true, "description": "Rule 12", "alert_name": "MSCAP - Windows Server Defence Evasion Codes to Monitor RAW (CCX) - Summary Gen", "alert_category": "EVASION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "xdm.source.host.hostname", "user": "xdm.source.user.username", "source": "src", "_vendor": "_vendor", "changes": "Changes", "_product": "_product", "eventcode": "eventcode", "subcategory": "Subcategory", "lasteventtime": "last_event_time", "alert_category": "Category", "firsteventtime": "first_event_time", "originalsourcetype": "orig_sourcetype"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["eventcode", "orig_sourcetype", "src", "xdm.source.user.username", "xdm.source.host.hostname", "Changes", "Subcategory", "Category"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0005 - Defense Evasion": ["T1562.001 - Impair Defenses: Disable or Modify Tools", "T1562.002 - Impair Defenses: Disable Windows Event Logging", "T1562.003 - Impair Defenses: Impair Command History Logging", "T1562.004 - Impair Defenses: Disable or Modify System Firewall", "T1562.006 - Impair Defenses: Indicator Blocking", "T1562.007 - Impair Defenses: Disable or Modify Cloud Firewall", "T1562.008 - Impair Defenses: Disable Cloud Logs"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 19, "name": "MSCAP - Users Attempting To Auth Using Explicit Credentials RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": " // Title: MSCAP - Users Attempting To Auth Using Explicit Credentials RAW (CCX) - Summary Gen\r\n/// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Datasets: microsoft_windows_raw \r\n// Date: 07/June/2024\r\n\r\ndatamodel dataset = microsoft_windows_raw \r\n \r\n| filter xdm.event.id =\"4648\"\r\n\r\n|alter\r\n    ProcessPath= arrayindex(regextract(xdm.event.description, \"Process Name:\\s+([^\\r\\n]+)\"),0 )\r\n| alter Target_Server= arrayindex(regextract(xdm.event.description, \"Target Server Name:\\s+([^\\r\\n]+)\"),0 )\r\n| filter xdm.source.user.username=\"*$\" AND ProcessPath != \"C:\\Windows\\System32\\taskhostw.exe\"\r\n| filter ProcessPath NOT IN (\"C:\\Windows\\System32\\svchost.exe\" , \"C:\\Windows\\System32\\winlogon.exe\", \"C:\\Windows\\System32\\lsass.exe\", \"C:\\Windows\\System32\\inetsrv\\w3wp.exe\") //Filtering known process Paths as they are known to be normal activity.\r\n| filter xdm.source.user.username != \"*$\" // Filtering Computer accounts running tasks, the objective of this detection is finding not computer accounts performing these tasks\r\n\r\n\r\n| comp     min(_time) as first_event_time, \r\n    max(_time) as last_event_time, count() by xdm.source.process.name , ProcessPath , xdm.target.user.username , xdm.source.user.username , xdm.source.host.hostname, Target_Server , xdm.event.description", "is_enabled": true, "description": "Rule 73", "alert_name": "MSCAP - Users Attempting To Auth Using Explicit Credentials RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"originalraw": "xdm.event.description", "processpath": "ProcessPath", "lasteventtime": "last_event_time", "agent_hostname": "xdm.source.host.hostname", "firsteventtime": "first_event_time", "action_local_ip": "Target_Server", "actor_effective_username": "xdm.target.user.username"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["ProcessPath", "Target_Server", "xdm.source.process.name", "xdm.target.user.username", "xdm.source.user.username", "xdm.source.host.hostname", "xdm.event.description", "first_event_time", "last_event_time"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0008 - Lateral Movement": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 20, "name": "MSCAP - RDP Login from Localhost RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - RDP Login from Localhost RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 06/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw\n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS\n| filter xdm.event.id = \"4624\"\n| filter xdm.logon.type = \"REMOTE_INTERACTIVE\"\n| filter xdm.source.ipv4 in (\"127.0.0.1\", \"::1\")\n\n| fields _time, xdm.event.id, xdm.event.original_event_type, xdm.logon.type, xdm.source.host.hostname, xdm.source.ipv4, xdm.observer.vendor, xdm.observer.product, xdm.target.user.username, xdm.target.user.upn, xdm.source.host.hostname, xdm.event.description ", "is_enabled": true, "description": "Rule 62", "alert_name": "MSCAP - RDP Login from Localhost RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.event.description", "xdm.event.id", "xdm.event.original_event_type", "xdm.logon.type", "xdm.observer.product", "xdm.observer.vendor", "xdm.source.host.hostname", "xdm.source.ipv4", "xdm.target.user.upn", "xdm.target.user.username"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0008 - Lateral Movement": ["T1021.001 - Remote Services: Remote Desktop Protocol"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "AUTO", "action": "ALERTS", "lookup_mapping": null}, {"rule_id": 21, "name": "MSANA - Breakglass Account Login Detection (PS) (CCX) - Summary Gen", "severity": "SEV_050_CRITICAL", "xql_query": "// Title: MSANA - Breakglass Account Login Detection (PS) (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 17/June/2024\r\n\r\ndataset = msft_azure_ad_raw \r\n\r\n|alter \r\n    user = userPrincipalName,\r\n    action = json_extract_scalar(status,\"$.errorCode\"),\r\n    status_failurereason = json_extract_scalar(status,\"$.failureReason\"),\r\n    src_ip = ipAddress,  \r\n    location_countryorregion = json_extract_scalar(location,\"$.countryOrRegion\"),\r\n    network_country= json_extract_scalar(networkLocationDetails,\"$.networknames\"),\r\n    authentication_method_details = json_extract_scalar(authenticationdetails,\"$.authenticationmethod\"),\r\n    authentication_how = json_extract_scalar(authenticationdetails,\"$.authenticationmethoddetail\"),\r\n    authentication_result = json_extract_scalar(authenticationdetails,\"$.authenticationstepresultdetail\")\r\n\r\n|filter user in (\"jack.yangbin@otmlhome.onmicrosoft.com\", \"guise.wartoto@otmlhome.onmicrosoft.com\")\r\n\r\n| fields user, src_ip, action, status_failurereason, appdisplayname, clientappused, location_countryorregion, network_country, authentication_method_details, authentication_how, authentication_result, _collector_type, _product, _vendor", "is_enabled": true, "description": "Rule 51", "alert_name": "[DRAFT] MSANA - Breakglass Account Login Detection (PS) (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"countryname": "network_country", "eventaction": "action", "clientappused": "clientAppUsed", "failurereason": "status_failurereason", "action_country": "location_countryorregion", "appdisplayname": "appDisplayName", "_collector_type": "_collector_type", "action_local_ip": "src_ip", "authenticationhow": "authentication_how", "authenticationmethod": "authentication_method_details", "authenticationresult": "authentication_result", "authenticationdetails": "authentication_method_details", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["appDisplayName", "authentication_result", "clientAppUsed", "authentication_how", "authentication_method_details", "src_ip", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 22, "name": "MSCAP - Detect Excessive Account Lockouts From Endpoint ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Detect Excessive Account Lockouts From Endpoint ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 07/June/2024\n\n/*\nAlert Suppression: 6h\nSuppression Fields: xdm.target.user.username, xdm.target.user.upn\n\nFields Mapping:\n\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw\n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id = \"4625\"\n// logon using RDP and device\n| filter xdm.logon.type in (\"INTERACTIVE\", \"REMOTE_INTERACTIVE\") // discus if any other login type are to be added\n\n// | fields _time, xdm.event.original_event_type, xdm.event.id, xdm.logon.type, xdm.source.host.hostname, xdm.source.ipv4, xdm.target.user.upn, xdm.target.user.username, xdm.observer.vendor, xdm.observer.product, microsoft_windows_raw.event_data, *\n\n| comp count() as total_failed_attempts, values(xdm.event.original_event_type) as orig_event_type, values(xdm.source.host.hostname) as host, values(xdm.source.ipv4) as src, \nvalues(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, min(_time) as login_failed_start_time, max(_time) as login_failed_end_time by xdm.target.user.username, xdm.target.user.upn\n| filter total_failed_attempts > 5  // filtering for login failed attempts count greater then 5 for a user\n\n| join (datamodel dataset = microsoft_windows_raw\n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS\n| filter xdm.event.id = \"4740\"\n| fields _time as account_locked_time, xdm.target.user.username as locked_account_user, xdm.source.host.hostname as locked_account_host) as locked_users locked_users.locked_account_user = xdm.target.user.username and timestamp_diff(locked_users.account_locked_time, login_failed_end_time, \"SECOND\") >= 0 \n\n| fields total_failed_attempts, login_failed_start_time, login_failed_end_time, account_locked_time, src, host, xdm.target.user.username, xdm.target.user.upn, vendor, product", "is_enabled": true, "description": "Rule 9", "alert_name": "MSCAP - Detect Excessive Account Lockouts From Endpoint ACC (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "host", "source": "src", "_vendor": "vendor", "endtime": "login_failed_end_time", "_product": "product", "starttime": "login_failed_start_time", "agent_hostname": null, "action_local_ip": null, "action_remote_ip": null, "accountlockedtime": "account_locked_time", "userprincipalname": "xdm.target.user.upn", "action_remote_port": null, "agent_device_domain": null, "totalfailedattempts": "total_failed_attempts", "actor_effective_username": "xdm.target.user.username", "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "12 minutes", "simple_schedule": "10 minutes", "timezone": "Asia/Calcutta", "crontab": "*/10 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.target.user.upn", "xdm.target.user.username"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1110 - Brute Force"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 23, "name": "MSCAP - Azure Service Principal Addition RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure Service Principal Addition RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 07/June/2024\n\n/*\nAlert Suppression: 6h\nSuppression Fields: activityDisplayName, user\n\nFields Mapping:\nUsername - user\nFirst Seen : first_event_time\nLast Seen : last_event_time\nEvent Action - activityDisplayName\nSource Status - result\nApp-ID : app\n*/\n\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw  \n| filter activityDisplayName = \"Add service principal\"\n| filter result = \"success\"\n| alter user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter InitiatedApp = json_extract_scalar(initiatedBy, \"$.app.displayName\")\n| alter app = json_extract_scalar(targetResources, \"$.0.displayName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n\n\n\n| comp count() as total_events, values(src) as src_ip, earliest(activityDateTime) as first_event_time, latest(activityDateTime) as last_event_time, values(app) as app, values(_vendor) as vendor, values(_product) as produt by activityDisplayName, user, InitiatedApp , result ", "is_enabled": true, "description": "Rule 38", "alert_name": "MSCAP - Azure Service Principal Addition RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"lastseen": "last_event_time", "firstseen": "first_event_time", "fw_app_id": "app", "eventaction": "activityDisplayName", "initiatedapp": "InitiatedApp", "sourcestatus": "result", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["activityDisplayName", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 24, "name": "MSCAP - Azure AAD MFA High Failure Ratio ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure AAD MFA High Failure Ratio ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_raw\n// Date: 10/June/2024\n\n/*\nAlert Suppression: 6h\nSuppression Fields: userPrincipalName, userDisplayName, authentication_method\n\nFields Mapping:\nUsername : userDisplayName\nEmail : userPrincipalName\nError Code : failure_code\nFailed Logon Event : failed_count\nStatus Reason : failure_reason\nLocation : location\nFirst Seen : first_event_time\nLast Seen : last_event_time\nApplicationname : app\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_raw  \n\n| alter authentication_method = json_extract_scalar(authenticationDetails, \"$.0.authenticationMethod\")\n| replacenull authentication_method = \"missing\"\n| filter authentication_method != \"missing\"\n| filter authentication_method not in (\"null\", \"previously satisfied\", \"password\", \"passwordless phone sign-in\")\n| alter authentication_step_req = json_extract_scalar(authenticationDetails, \"$.0.authenticationStepResultDetail\")\n| alter error_code = status -> errorCode\n| alter failure_reason = status -> failureReason\n// | alter additional_details = status -> additionalDetails\n\n| alter city = location -> city\n| alter country = location -> countryOrRegion\n| alter state = location -> state\n| alter location = format_string(\"%s | %s | %s\", city, state, country)\n\n| comp count() as total_event, count(if(error_code = \"0\", True)) as success_count, count(if(error_code != \"0\", True)) as failed_count, earliest(createdDateTime) as first_event_time, latest(createdDateTime) as last_event_time, values(if(error_code != \"0\", error_code)) as failure_code, values(if(error_code != \"0\", failure_reason)) as failure_reason, values(ipAddress) as src_ip, values(appDisplayName) as app, values(location) as location, values(_product) as product, values(_vendor) as vendor by userPrincipalName, userDisplayName, authentication_method\n| filter failed_count > 10\n| filter success_count > 1\n| alter failure_ratio = divide(failed_count, total_event)\n| filter failure_ratio > 0.5", "is_enabled": true, "description": "Rule 11", "alert_name": "MSCAP - Azure AAD MFA High Failure Ratio ACC (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"email": "userPrincipalName", "_vendor": "vendor", "_product": "product", "lastseen": "last_event_time", "location": "location", "sourceip": "src_ip", "firstseen": "first_event_time", "failedcount": "failed_count", "failurecode": "failure_code", "totalevents": "total_event", "failureratio": "failure_ratio", "successcount": "success_count", "failurereason": "failure_reason", "applicationname": "app", "authenticationmethod": "authentication_method", "actor_effective_username": "userDisplayName"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["userDisplayName", "userPrincipalName", "authentication_method"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": [], "TA0006 - Credential Access": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 26, "name": "MSCAP - Initial Access Consent Grant Attack via Azure Application RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Initial Access Consent Grant Attack via Azure Application RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 10/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : activityDisplayName, user, app\n\nFields Mapping:\nUsername : user\nFirst Seen : first_event_time\nLast Seen : last_event_time\nEvent Action : activityDisplayName\nApp-ID : app\nSource Status : result\n\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw \n| filter activityDisplayName = \"*consent to application*\"\n| filter result = \"success\"\n\n| alter user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n| alter app = json_extract_scalar(targetResources, \"$.0.displayName\")\n| alter object_id = json_extract_scalar(targetResources, \"$.0.id\")\n| alter app_id = json_extract_scalar(additionalDetails, \"$.1.value\")\n| alter initiatedApp = json_extract_scalar(initiatedBy, \"$.app.displayName\")\n\n//filter of known Apps that are only Low Security // Production-PhishReporter, Sharepoint|Sapeins Connector, SignEasy, EasyLife 3655 Mail, Lucidpark, Employee Lookup, Teams Embedded Dashboard|Industry Intelligence are Enteprise Apps (which is allowed and permissions are set to low) All these apps have been reviewed.\n| filter app NOT IN (\"SharePoint|sapiens Connector\", \"Signeasy\", \"Production-PhishReporter\" , \"EasyLife 365 Mail\" , \"Lucidspark\" , \"Employee Lookup\", \"Teams Embedded Dashboard | Industry Intelligence Inc.\")\n\n| fields activityDateTime, user, src, app, app_id, object_id, activityDisplayName, operationType, category, _vendor, _product, result, *\n| comp count() as total_events, values(src) as src_ip, earliest(activityDateTime) as first_event_time, latest(activityDateTime) as last_event_time,  values(_vendor) as vendor, values(_product) as produt by app, app_id, object_id, activityDisplayName, user, initiatedApp, result", "is_enabled": true, "description": "Rule 33", "alert_name": "MSCAP - Initial Access Consent Grant Attack via Azure Application RAW (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "result": "result", "_vendor": "vendor", "_product": "produt", "objectid": "object_id", "sourceip": "src_ip", "totalevents": "total_events", "initiatedapp": "initiatedApp", "applicationid": "app_id", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "activitydisplayname": "activityDisplayName", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "20 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["user", "activityDisplayName", "app"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1566.002 - Phishing: Spearphishing Link"], "TA0006 - Credential Access": ["T1528 - Steal Application Access Token"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 27, "name": "MSCAP - Azure Active Directory PowerShell Sign-in RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": " // Title: MSCAP - Azure Active Directory PowerShell Sign-in RAW (CCX) - Summary Gen\n/// Author: Deven Amode, damode@paloaltonetworks.com\n// Datasets: msft_azure_ad_raw\n// Date: 11/June/2024\n\nconfig case_sensitive = false\n|dataset = msft_azure_ad_raw\n|fields _time, appdisplayname as app, userprincipalname as user , tokenIssuerType, status,_collector_type,_reporting_device_name, _vendor,_product, ipAddress \n|filter user != \"priv.*\" // Filtering Administrators expected logins\n|filter user != \"svc.snow@otmlhome.onmicrosoft.com\" AND ipAddress != \"202.1.241.28\" // Filtering SVC SNOW login in from known IP address\n|alter status_error_code = json_extract_scalar(status, \"$.errorCode\")\n|filter app =\"*powershell*\" and tokenIssuerType =\"azuread\" and status_error_code = \"0\"\n|alter user = lowercase(user),action = if(status_error_code = \"0\", \"allowed\", status_error_code)", "is_enabled": true, "description": "Rule 35", "alert_name": "MSCAP - Azure Active Directory PowerShell Sign-in RAW (CCX) - Summary Gen", "alert_category": "EVASION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "user": "user", "_vendor": "_vendor", "_product": "_product", "eventaction": "action", "failurereason": "status", "actoripaddress": "ipAddress", "_collector_type": "_collector_type", "statuserrorcode": "status_error_code", "tokenissuertype": "tokenIssuerType", "_reporting_device_name": "_reporting_device_name"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["app", "user", "tokenIssuerType", "status"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1078.004 - Valid Accounts: Cloud Accounts"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 28, "name": "MSCAP - User Added as Owner for Azure Application RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - User Added as Owner for Azure Application RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 11/June/2024\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw \n| filter activityDisplayName = \"*add owner to application*\"\n| filter result = \"success\"\n\n| alter user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n| alter app = json_extract_scalar(targetResources, \"$.0.displayName\")\n| alter Initiator_app = json_extract_scalar(initiatedBy, \"$.app.displayName\")\n\n| filter Initiator_app!=\"Power Virtual Agents Service\"\n\n| fields activityDateTime, user, src, app, activityDisplayName as signature, operationType, category, _vendor, _product, result, *\n| comp count() as total_events, values(src) as src_ip, earliest(activityDateTime) as first_event_time, latest(activityDateTime) as last_event_time, values(app) as app, values(_vendor) as vendor, values(_product) as product by signature, user, result, Initiator_app ", "is_enabled": true, "description": "Rule 55", "alert_name": "MSCAP - User Added as Owner for Azure Application RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "signature": "signature", "totalevents": "total_events", "initiatedapp": "Initiator_app", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "action_local_ip": "src_ip", "eventdescription": "result", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["app", "src_ip", "user", "signature"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098.001 - Account Manipulation: Additional Cloud Credentials"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 29, "name": "MSCAP - Azure Service Principal Credentials Added RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure Service Principal Credentials Added RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 11/June/2024\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw \n| filter activityDisplayName = \"*add service principal credentials*\"\n| filter result = \"success\"\n\n| alter user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n| alter app = json_extract_scalar(targetResources, \"$.0.displayName\")\n\n| fields  _time, app, user, activityDateTime as signature, _collector_type , category, _vendor, _product", "is_enabled": true, "description": "Rule 54", "alert_name": "MSCAP - Azure Service Principal Credentials Added RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "signature": "signature", "alert_category": "category", "_collector_type": "_collector_type", "activitydatetime": "_insert_time", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["app", "user", "signature"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0040 - Impact": ["T1496 - Resource Hijacking"], "TA0003 - Persistence": ["T1136.003 - Create Account: Cloud Account"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 30, "name": "MSCAP - User Added as Owner for Azure Service Principal RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - User Added as Owner for Azure Service Principal RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 11/June/2024\n//PS24SEP24 - adding initated by and src to fields.\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw \n| filter activityDisplayName = \"*add owner to service principal*\" and result = \"success\"\n\n| alter \n    user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\"),\n    src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\"),\n    target_app = json_extract_scalar(targetResources, \"$.0.displayName\"),\n    user_type = json_extract_scalar(targetResources, \"$.0.type\"),\n    initiator_app = json_extract_scalar (initiatedBy, \"$.app.displayName\")\n\n| fields  _time, target_app, initiator_app, src,  user, user_type, activityDisplayName as signature, _collector_type , _vendor, _product", "is_enabled": true, "description": "Rule 57", "alert_name": "MSCAP - User Added as Owner for Azure Service Principal RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "target_app", "_vendor": "_vendor", "usertype": "user_type", "signature": "signature", "initiatedapp": "initiator_app", "vendorproduct": "_product", "actoripaddress": "src", "_collector_type": "_collector_type", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["target_app", "initiator_app", "src", "user", "user_type", "signature", "_collector_type", "_vendor", "_product", "_insert_time", "_tag", "_raw_log", "_id"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098.001 - Account Manipulation: Additional Cloud Credentials"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 31, "name": "MSCAP - Active Directory User Backdoors RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Active Directory User Backdoors RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 11/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields: xdm.event.id, xdm.event.original_event_type, object_class, attribute_ldap_display_name\n*/\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS\n| filter xdm.source.user.username != \"SVC.SCCM\"\n\n| alter allowed_to_delegate_to = json_extract_scalar(microsoft_windows_raw.event_data, \"$.AllowedToDelegateTo\")\n| alter attribute_ldap_display_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.AttributeLDAPDisplayName\")\n| alter object_class = json_extract_scalar(microsoft_windows_raw.event_data, \"$.ObjectClass\")\n| replacenull attribute_ldap_display_name = \"missing\", object_class = \"missing\"\n\n| alter p1 = if(xdm.event.id = \"4738\" and allowed_to_delegate_to not in (\"-\", \"*\", \"<value not set>\"), true, false)  // do we need to filter out \"\" and null values for allowed_to_delegate_to\n| alter p2 = if(xdm.event.id = \"5136\" and attribute_ldap_display_name = \"msds-allowedtodelegateto\", true, false)\n| alter p3 = if(xdm.event.id = \"5136\" and object_class = \"user\" and attribute_ldap_display_name = \"serviceprincipalname\", true, false)\n| alter p4 = if(xdm.event.id = \"5136\" and attribute_ldap_display_name = \"msds-allowedtoactonbehalfofotheridentity\", true, false)\n\n| alter result = if(p1 or (p2 or p3 or p4), true, false)\n| filter result = true\n\n| comp count() as total_events, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.source.host.hostname) as host, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, values(xdm.source.user.username) as user, values(xdm.source.ipv4) as src by xdm.event.id, xdm.event.original_event_type, object_class, attribute_ldap_display_name", "is_enabled": true, "description": "Rule 47", "alert_name": "MSCAP - Active Directory User Backdoors RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "host", "user": "user", "source": "src", "_vendor": "vendor", "eventid": "xdm.event.id", "_product": "product", "objectclass": "object_class", "totalevents": "total_events", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "ldapdisplayname": "attribute_ldap_display_name", "originaleventtype": "xdm.event.original_event_type"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["object_class", "attribute_ldap_display_name", "xdm.event.id", "xdm.event.original_event_type"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098.001 - Account Manipulation: Additional Cloud Credentials"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 32, "name": "MSCAP - Kerberos User Enumeration RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Kerberos User Enumeration RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 11/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.event.original_event_type, xdm.event.id, xdm.source.ipv4, user\n*/\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS\n| filter xdm.event.id = \"4768\"\n| alter status = json_extract_scalar(microsoft_windows_raw.event_data, \"$.Status\")\n| filter status = \"0x6\"\n| filter xdm.target.user.username != \"*$\"\n| replacenull xdm.source.ipv4 = \"missing\"\n\n//filter for Exchange Server \n\n| filter xdm.source.ipv4 != \"10.64.1.163\"\n\n//filter for Gallagher system\n\n| filter xdm.source.ipv4 != \"10.10.134.40\"\n\n\n| fields _time, xdm.event.id, status, xdm.source.host.hostname, xdm.target.user.username, xdm.source.ipv4, xdm.target.ipv4, microsoft_windows_raw.event_data, *\n| comp count() as total_events, count_distinct(xdm.target.user.username) as unique_user_count, values(xdm.target.user.username) as user, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product by xdm.event.original_event_type, xdm.event.id, xdm.source.ipv4 \n| filter unique_user_count > 10 // filtering for more than 10 attempts to enumerate user accoutns user Kerberos", "is_enabled": true, "description": "Rule 49", "alert_name": "MSCAP - Kerberos User Enumeration RAW (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"user": "user", "_vendor": "vendor", "eventid": "xdm.event.id", "_product": "product", "sourceip": "xdm.source.ipv4", "totalevents": "total_events", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "uniqueusercount": "unique_user_count", "originaleventtype": "xdm.event.original_event_type"}, "execution_mode": "SCHEDULED", "search_window": "12 minutes", "simple_schedule": "10 minutes", "timezone": "Asia/Calcutta", "crontab": "*/10 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.event.id", "xdm.event.original_event_type", "xdm.source.ipv4", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1110.003 - Brute Force: Password Spraying"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 36, "name": "MSANA - Azure Risky Sign-in Outside AU/PG (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSANA - Azure Risky Sign-in Outside AU/PG (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 12/June/2024\r\n\r\ndataset = msft_azure_ad_raw \r\n|alter \r\n    country_or_region = json_extract_scalar(location , \"$.countryOrRegion\")\r\n\r\n| filter isInteractive != 0\r\n| filter userPrincipalName != \"Tendai.Hove@oktedi.com\" and  country_or_region !=\"ZW\" //Filtering temp_any_user=\"Tendai.Hove@oktedi.com\" AND tld=ZW - (CS) PS 28NOV2023 - user expected to be in Zimbabwe.\r\n| filter userPrincipalName != \"david.gouws@oktedi.com\" AND country_or_region != \"ZA\" //temp_user=\"david.gouws@oktedi.com\" AND temp_src=\"165.255.244.179\" - (CS) PS 29JAN2024 - removing this user from detection as allowed and expected to be in ZA.\r\n| filter userPrincipalName != \"wenrui.zhou@oktedi.com\" // User is a SAP consultant\r\n| filter userPrincipalName != \"eliuda.tamlick@oktedi.com\" //Need to be reviewed, as this user use VPN \r\n| filter userPrincipalName NOT IN (\"naveen.sharma@oktedi.com\", \"atul.gupta@sap.com\") AND country_or_region != \"IN\" //SAP consultant from India\r\n| filter userPrincipalName != \"zulfi.asdani@oktedi.com\" AND country_or_region != \"ID\"\r\n| filter ipAddress != \"52.253.83.89\" AND userPrincipalName != \"*@oktedi.com\" //this is the IP address from a DataCenter in Singapore\r\n| filter userPrincipalName !=\"todd@gsanalysis.com\" AND country_or_region != \"US\" // Allowed gsanalsysis.com users to login from the US\r\n| filter userPrincipalName !=\"mgoss@amcconsultants.com\" AND country_or_region !=\"ZM\" //African Mining Consults AMC allowed to login into OTML for this user mgoss Only.\r\n| filter userPrincipalName != \"cameron@epts.co.nz\" AND country_or_region != \"NZ\" //Allowed NZ Contractor to connect to OTML network\r\n\r\n|filter country_or_region not in (\"au\", \"pg\", \"\")\r\n| iploc ipAddress loc_continent AS Continent, loc_country AS Country, loc_region AS Region, loc_city AS City, loc_latlon AS lon\r\n|fields _time, ipAddress as src,userprincipalname as user, userDisplayName as UserDisplay, country_or_region as tld , _vendor ,_product", "is_enabled": true, "description": "Rule 65", "alert_name": "MSANA - Azure Risky Sign-in Outside AU/PG (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"userid": "user", "_vendor": "_vendor", "vendorproduct": "_product", "action_country": "tld", "action_local_ip": "src", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["src", "tld", "user", "_id", "_insert_time"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 37, "name": "MSCAP - Azure Conditional Access Policy Modified RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure Conditional Access Policy Modified RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 12/June/2024\n\n/*\nAlert Suppressioin : 6h\nSuppression Fields : activityDisplayName, category, operationType, result, user, src, app, modified_properties, modified_properties_old_value, modified_properties_new_value\n\nFields Mapping :\nUsername : user\nCategory : category\nSource Create Time : activityDateTime\nOperation Name : activityDisplayName\nAdditional Data : modified_properties\nApp-ID : app\nEvent Action : operationType\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw\n| filter activityDisplayName = \"update conditional access policy\"\n| alter user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n| alter app = json_extract_scalar(targetResources, \"$.0.displayName\")\n| filter result = \"success\"\n\n| alter modified_properties = json_extract_array(targetResources, \"$.0.modifiedProperties\")\n| alter modified_properties_old_value = arraymap(modified_properties, if(\"@element\" -> displayName = \"ConditionalAccessPolicy\", \"@element\" -> oldValue))\n| alter modified_properties_new_value = arraymap(modified_properties, if(\"@element\" -> displayName = \"ConditionalAccessPolicy\", \"@element\" -> newValue))\n| fields activityDateTime, activityDisplayName, category, operationType, result, user, src, app, modified_properties, modified_properties_old_value, modified_properties_new_value, _vendor, _product", "is_enabled": true, "description": "Rule 64", "alert_name": "MSCAP - Azure Conditional Access Policy Modified RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "result": "result", "_vendor": "_vendor", "eventaction": "operationType", "operationname": "activityDisplayName", "operationtype": "operationType", "vendorproduct": "_product", "additionaldata": "modified_properties", "alert_category": "category", "sourcecreatetime": "activityDateTime", "modifiedproperties": "modified_properties", "modifiedpropertiesnew": "modified_properties_new_value", "modifiedpropertiesold": "modified_properties_old_value", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["activityDisplayName", "app", "category", "modified_properties", "modified_properties_new_value", "modified_properties_old_value", "operationType", "result", "src", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098.001 - Account Manipulation: Additional Cloud Credentials"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 38, "name": "MSCAP - Azure AAD Global Administrator Role Assignment RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure AAD Global Administrator Role Assignment RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: \n// Date: 12/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : target_user, activityDisplayName, operationType\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw\n| filter activityDisplayName = \"*member to role*\"\n| filter result = \"success\"\n\n| alter modified_properties = json_extract_array(targetResources, \"$.0.modifiedProperties\")\n| alter target_role_display_name = arrayindex(arraymap(modified_properties, if(\"@element\" -> displayName = \"Role.DisplayName\", \"@element\" -> newValue)), 0)\n| alter target_template_id = arrayindex(arraymap(modified_properties, if(\"@element\" -> displayName = \"Role.TemplateId\", \"@element\" -> newValue)), 0)\n| filter target_role_display_name contains \"global administrator\" or target_template_id contains \"62e90394-69f5-4237-9190-012177145e10\"\n\n| alter src_user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n| alter src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\")\n| alter app = json_extract_scalar(initiatedBy, \"$.app.displayName\")\n| alter target_user = json_extract_scalar(targetResources, \"$.0.userPrincipalName\")\n| alter target_display_name = json_extract_scalar(targetResources, \"$.0.displayName\")\n| alter target_role_wellknown_name = arrayindex(arraymap(modified_properties, if(\"@element\" -> displayName = \"Role.WellKnownObjectName\", \"@element\" -> newValue)), 0)\n\n| replacenull src_user = \"missing\", src = \"missing\", app = \"missing\", target_role_display_name = \"missing\", target_template_id = \"missing\", target_role_wellknown_name = \"missing\"\n| fields activityDateTime, activityDisplayName, result, category, operationType, app, src_user, target_user, target_role_display_name, target_template_id, target_display_name, target_role_wellknown_name, modified_properties, _vendor, _product, *\n\n| comp count() as total_events, values(activityDateTime) as first_event_time, values(activityDateTime) as last_event_time, values(_vendor) as vendor, values(_product) as product, values(src_user) as src_user, values(src) as src, values(app) as app, values(target_role_display_name) as target_role_display_name, values(target_template_id) as target_template_id, values(target_role_wellknown_name) as target_role_wellknown_name by target_user, activityDisplayName, result, operationType", "is_enabled": true, "description": "Rule 66", "alert_name": "MSCAP - Azure AAD Global Administrator Role Assignment RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "result": "result", "_vendor": "vendor", "targetuser": "target_user", "totalevents": "total_events", "lasteventtime": "last_event_time", "operationtype": "operationType", "vendorproduct": "product", "firsteventtime": "first_event_time", "action_local_ip": "src", "targettemplateid": "target_template_id", "newtargetusername": "target_role_wellknown_name", "activitydisplayname": "activityDisplayName", "targetroledisplayname": "target_role_display_name", "actor_effective_username": "src_user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["target_user", "activityDisplayName", "operationType"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": [], "TA0001 - Initial Access": ["T1078.004 - Valid Accounts: Cloud Accounts"], "TA0005 - Defense Evasion": [], "TA0004 - Privilege Escalation": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 39, "name": "MSCAP - Web JSP Request via URL ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Web JSP Request via URL ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: datamodel\n// Date: 12/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.source.user_agent, xdm.network.http.url, xdm.source.ipv4, xdm.target.ipv4\n*/\n\nconfig case_sensitive = false\n| datamodel dataset in (mimecast_mimecast_raw, panw_ngfw_url_raw, msft_o365_azure_ad_raw)\n| filter xdm.event.type = \"threat\"\n| filter xdm.network.http.method = XDM_CONST.HTTP_METHOD_GET \n| filter xdm.network.http.url in (\"*.jsp?cmd=*\", \"*j&cmd=*\")\n\n// filtering for inbound requests\n| filter incidr(xdm.source.ipv4, \"10.0.0.0/8\") = false and incidr(xdm.source.ipv4, \"172.16.0.0/12\") = false and incidr(xdm.source.ipv4, \"192.168.0.0/16\") = false // filter source ip not local ip\n| filter incidr(xdm.target.ipv4, \"10.0.0.0/8\") = true or incidr(xdm.target.ipv4, \"172.16.0.0/12\") = true or incidr(xdm.target.ipv4, \"192.168.0.0/16\") = true // filter for target ip  is local ip\n\n| comp count() as total_http_requests, earliest(_time) as first_seen, latest(_time) as last_seen, values(xdm.source.user.username) as user, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product by xdm.source.user_agent, xdm.network.http.method, xdm.network.http.url, xdm.source.ipv4, xdm.target.ipv4", "is_enabled": true, "description": "Rule 36", "alert_name": "MSCAP - Web JSP Request via URL ACC (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"user": "user", "_vendor": "vendor", "_product": "product", "lastseen": "last_seen", "sourceip": "xdm.source.ipv4", "firstseen": "first_seen", "httpmethod": "xdm.network.http.method", "user_agent": "xdm.source.user_agent", "detectionurl": "xdm.network.http.url", "destinationip": "xdm.target.ipv4", "fw_url_domain": "xdm.network.http.url", "totalhttprequests": "total_http_requests"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.source.ipv4", "xdm.target.ipv4", "xdm.network.http.url", "xdm.source.user_agent"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1505 - Server Software Component", "T1505.003 - Server Software Component: Web Shell"], "TA0001 - Initial Access": ["T1190 - Exploit Public-Facing Application"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 40, "name": "MSCAP - User Couldn't Call a Privileged Service LsaRegisterLogonProcess RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - User Couldn't Call a Privileged Service LsaRegisterLogonProcess RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Date: 13/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| alter \n    service = json_extract_scalar(microsoft_windows_raw.event_data, \"$.service\"),\n    subjectusersid = json_extract_scalar(microsoft_windows_raw.event_data, \"$.subjectusersid\")\n| filter xdm.event.id  = \"4673\" and service=\"lsaregisterlogonprocess()\" and microsoft_windows_raw.keywords = \"0x8010000000000000\" and subjectusersid not in (\"nt authority\\\\network service\", \"nt service\\\\msolap$datainsight\")\n|fields _time,_vendor as vendor,_product as vendor_product, microsoft_windows_raw._raw_log as orig_raw, xdm.source.host.hostname as orig_host, xdm.target.ipv4 as dest,xdm.observer.type as orig_sourcetype,xdm.source.ipv4 as src, xdm.source.user.username as user, microsoft_windows_raw.keywords as keywords,service, xdm.event.id as eventcode\n| comp values(orig_raw) , values(vendor) , values(vendor_product) , values(orig_host) , values(orig_sourcetype), values(src), values(user), earliest(_time) as first_event_time, latest(_time) as last_event_time by dest, eventcode, service, keywords  ", "is_enabled": true, "description": "Rule 72", "alert_name": "MSCAP - User Couldn't Call a Privileged Service LsaRegisterLogonProcess RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"eventcode": "eventcode", "description": "keywords", "servicename": "service", "lasteventtime": "last_event_time", "agent_hostname": null, "firsteventtime": "first_event_time", "action_local_ip": null, "action_remote_ip": "dest", "action_remote_port": null, "agent_device_domain": null, "actor_effective_username": null, "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["eventcode", "service", "keywords", "dest"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1558.003 - Steal or Forge Kerberos Tickets: Kerberoasting"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 41, "name": "MSCAP - Kerberoasting SPN request against Excessive Accounts RAW (CCX) - Summary Gen", "severity": "SEV_040_HIGH", "xql_query": "// Title: MSCAP - Kerberoasting SPN request against Excessive Accounts RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Date: 13/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| alter \n    service_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.ServiceName\"),\n    service_id = json_extract_scalar(microsoft_windows_raw.event_data, \"$.ServiceSid\"),\n    ticket_options = json_extract_scalar(microsoft_windows_raw.event_data, \"$.TicketOptions\"),\n    ticket_encryption_type = json_extract_scalar(microsoft_windows_raw.event_data, \"$.TicketEncryptionType\")\n| filter xdm.event.id  = \"4769\" and service_name != \"*$\" and ticket_options in (\"0x40810000\",\"0x40800000\",\"0x40810010\") and ticket_encryption_type=\"0x17\"\n| fields *, xdm.source.user.username as user,microsoft_windows_raw._raw_log\n\n//filter for this detection, all SAP Services SCCM, ADFS and SPFARM_PRD that can trigger this alert and is part of Regular Activity from these accounts.\n| filter service_name NOT IN ( \"SAPSERVICEB1R\", \"SAPSERVICEE1D\", \"SAPSERVICEE1P\", \"SAPSERVICEE1Q\", \"SAPSERVICEE1R\", \"SAPSERVICEP1D\", \"SAPSERVICEP1P\", \"SAPSERVICEP1Q\", \"SAPSERVICEP1R\", \"SAPSERVICES1P\",\"SAPServiceE1S\",\"SVC.ADFS\", \"SVC.SCCM\", \"SVC_SPFARM_PRD\", \"SAPSERVICEB1P\")\n\n\n| comp values(microsoft_windows_raw._raw_log) as orig_raw, values(xdm.source.ipv4) as src, values(xdm.target.ipv4) as dest ,values(service_name) as service_name, count_distinct(service_name) as service_count, values(service_id) as service_id, values(ticket_encryption_type) as ticket_encryption_type, values(ticket_options) as ticket_options, values(xdm.event.id) as eventcode, values(_vendor) as vendor , values(_product) as vendor_product , values(xdm.source.host.hostname) as orig_host, values(xdm.observer.type)as orig_sourcetype, earliest(_time) as first_event_time, latest(_time) as last_event_time by user\n", "is_enabled": true, "description": "Rule 69", "alert_name": "MSCAP - Kerberoasting SPN request against Excessive Accounts RAW (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"eventcode": "eventcode", "serviceid": "service_id", "originalraw": "orig_raw", "servicename": "service_name", "servicecount": "service_count", "lasteventtime": "last_event_time", "logsourcetype": "orig_sourcetype", "ticketoptions": "ticket_options", "agent_hostname": "orig_host", "firsteventtime": "first_event_time", "action_local_ip": "src", "action_remote_ip": "dest", "ticketencryptiontype": "ticket_encryption_type", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["user", "ticket_encryption_type", "ticket_options", "service_id", "service_count", "orig_host", "eventcode", "service_name", "src"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1558.003 - Steal or Forge Kerberos Tickets: Kerberoasting"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 42, "name": "MSCAP - User Added to Local Administrators RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - User Added to Local Administrators RAW (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Date: 13/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| alter \n    xdm.target.user.username  = json_extract_scalar(microsoft_windows_raw.event_data, \"$.TargetUserName\"),\n    xdm.target.resource.id =json_extract_scalar(microsoft_windows_raw.event_data,\"$.targetsid\"),\n    subject_username = json_extract_scalar(microsoft_windows_raw.event_data, \"$.SubjectUserName\")\n| filter xdm.event.id  = \"4732\" and xdm.target.user.username = \"administr*\" or  xdm.target.resource.id=\"s-1-5-32-544\" and subject_username != \"*$\" \n| fields *, xdm.source.user.username as user,microsoft_windows_raw._raw_log, xdm.event.id as event_code,xdm.target.ipv4 as dest\n\n|alter\n    SecurityID = arrayindex(regextract(xdm.event.description, \"Member:\\s+Security ID:\\s+(S-\\d-\\d+-\\d+-\\d+-\\d+-\\d+-\\d+)\"),0 )\n|filter SecurityID != \"S-1-5-21*\" //Filtering Non-Unique SIDs that are well known https://learn.microsoft.com/en-us/windows/win32/secauthz/well-known-sids\n\n\n| comp values(microsoft_windows_raw._raw_log) as orig_raw, values(_vendor) as vendor , values(_product) as vendor_product , values(xdm.source.host.hostname) as orig_host, values(xdm.observer.type)as orig_sourcetype, earliest(_time) as first_event_time, latest(_time) as last_event_time by  xdm.target.user.username , dest, user, event_code, xdm.event.description , SecurityID ", "is_enabled": true, "description": "Rule 58", "alert_name": "MSCAP - User Added to Local Administrators RAW (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"eventcode": "event_code", "targetuser": "xdm.target.user.username", "originalraw": "orig_raw", "logsourcetype": "orig_sourcetype", "vendorproduct": "vendor_product", "agent_hostname": "orig_host", "action_remote_ip": "dest", "eventdescription": "xdm.event.description", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["event_code", "user", "xdm.target.user.username", "orig_host"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098 - Account Manipulation"], "TA0001 - Initial Access": ["T1078 - Valid Accounts"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 43, "name": "MSCAP - Suspicious Email Attachment Extensions ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Suspicious Email Attachment Extensions ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: \n// Date: 13/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.email.sender, xdm.email.message_id\n*/\n\nconfig case_sensitive = false \n|  datamodel dataset = mimecast_mimecast_raw\n\n// REGEX method - uncomment this section to use\n| alter file_name_list = arraystring(json_extract_scalar_array(to_json_string(replace(xdm.email.attachment.filename,\"\\\\\"\",\"\")),\"$\"),\",\")\n| alter matched_file_name =  regextract(file_name_list,\"(?:avi|doc|docx|jpg|jpeg|mpg|mpg2|mpeg|pdf|png|ppt|pptx|swf|xls|xlsx|zip)\\.(?:com|exe)(?:,|$)|\\.(?:bat|chm|com|cmd|cpl|exe|hlp|hta|jar|js|msi|pif|ps1|rar|reg|scr|vbe|vbs|wsf)(?:,|$)\")\n| filter matched_file_name != null\n\n\n/*\n| filter xdm.email.attachment.filename in (\"*.avi.com\", \"*.avi.exe\", \"*.doc.com\", \"*.doc.exe\", \"*.docx.com\", \"*.docx.exe\", \"*.jpg.com\", \"*.jpg.exe\", \n \"*.jpeg.com\", \"*.jpeg.exe\", \"*.mpg.com\", \"*.mpg.exe\", \"*.mpg2.com\", \"*.mpg2.exe\", \"*.mpeg.com\", \"*.mpeg.exe\", \"*.pdf.com\", \"*.pdf.exe\", \n \"*.png.com\", \"*.png.exe\", \"*.ppt.com\", \"*.ppt.exe\", \"*.pptx.com\", \"*.pptx.exe\", \"*.swf.com\", \"*.swf.exe\", \"*.xls.com\", \"*.xls.exe\", \n \"*.xlsx.com\", \"*.xlsx.exe\", \"*.zip.com\", \"*.zip.exe\", \"*.bat\", \"*.chm\", \"*.com\", \"*.cmd\", \"*.cpl\", \"*.exe\", \"*.hlp\", \"*.hta\", \"*.jar\", \"*.js\", \n \"*.msi\", \"*.pif\", \"*.ps1\", \"*.rar\", \"*.reg\", \"*.scr\", \"*.vbe\", \"*.vbs\", \"*.wsf\")\n | filter xdm.email.attachment.filename NOT IN (\"*.com_*\", \"* RAR *\", \"*salesforce.com*\" , \"*.json\", \"*.com.jpeg\")\n*/\n\n| comp count() as total_events, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, earliest(_time) as first_event_time, latest(_time) as last_event_time, \nvalues(file_name_list) as file_name by xdm.email.sender, xdm.email.message_id \n\n| join (\ndatamodel dataset = mimecast_mimecast_raw\n| alter email_recipients = arraystring(xdm.email.recipients, \",\")\n\n// filtering for null or empty results in attachment filename, message_id and recipients\n| filter xdm.email.attachment.filename in (\"\", null)\n| filter xdm.email.message_id not in (\"\", null)\n| filter email_recipients not in (\"\", null)\n| fields xdm.email.message_id as message_id, xdm.email.sender as email_sender, email_recipients\n| comp values(email_recipients) as email_recipients by message_id, email_sender \n| limit 10000000\n) as recipient_data recipient_data.message_id  = xdm.email.message_id \n\n| fields total_events, first_event_time, last_event_time, xdm.email.message_id, xdm.email.sender, email_recipients, file_name, vendor, product", "is_enabled": true, "description": "Rule 63", "alert_name": "MSCAP - Suspicious Email Attachment Extensions ACC (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "vendor", "totalevents": "total_events", "lasteventtime": "last_event_time", "vendorproduct": "product", "emailmessageid": "xdm.email.message_id", "firsteventtime": "first_event_time", "fw_email_sender": "xdm.email.sender", "action_file_name": "file_name", "fw_email_recipient": "email_recipients"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.email.message_id", "xdm.email.sender"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1566.001 - Phishing: Spearphishing Attachment", "T1566 - Phishing"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 45, "name": "MSCAP - Multiple Users Remotely Failing To Authenticate From Host RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Multiple Users Remotely Failing To Authenticate From Host RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: \n// Date: 13/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : workstation_name, xdm.source.user.username, target_user\n*/\n\nconfig case_sensitive = false\n|  datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id = \"4625\"\n| filter xdm.logon.type = \"NETWORK\"\n| filter xdm.source.user.username != \"-\"\n\n| alter workstation_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.WorkstationName\")\n| replacenull workstation_name = \"missing\"\n\n| comp count() as total_events, count_distinct(xdm.target.user.username) as unique_accounts, values(xdm.source.host.hostname) as host, values(xdm.target.user.username) as target_user, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.event.original_event_type) as event_type, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product by workstation_name, xdm.source.user.username, xdm.event.id\n\n| filter unique_accounts > 10 // filtering for more than 10 unique user accounts", "is_enabled": true, "description": "Rule 71", "alert_name": "MSCAP - Multiple Users Remotely Failing To Authenticate From Host RAW (CCX) - Summary Gen", "alert_category": "CREDENTIAL_ACCESS", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "vendor", "eventid": "xdm.event.id", "targetuser": "target_user", "totalevents": "total_events", "workstation": "workstation_name", "lasteventtime": "last_event_time", "vendorproduct": "product", "agent_hostname": "host", "firsteventtime": "first_event_time", "uniqueaccounts": "unique_accounts", "action_local_ip": null, "action_remote_ip": null, "originaleventtype": "event_type", "action_remote_port": null, "agent_device_domain": null, "actor_effective_username": "xdm.source.user.username", "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "12 minutes", "simple_schedule": "10 minutes", "timezone": "Asia/Calcutta", "crontab": "*/10 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.source.user.username", "target_user", "workstation_name"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0006 - Credential Access": ["T1110.003 - Brute Force: Password Spraying"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 46, "name": "MSCAP - Short Lived Windows Accounts ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Short Lived Windows Accounts ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 13/June/2024\n\n/*\nAlert Suppression : 8h\nSuppression Fields : xdm.target.user.username\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id in (\"4726\", \"4720\")\n\n| alter user_principal_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.UserPrincipalName\")\n| alter user_display_name = json_extract_scalar(microsoft_windows_raw.event_data , \"$.DisplayName\")\n\n| alter user_creation_time = if(xdm.event.id = \"4720\", _time)\n| alter user_deletion_time = if(xdm.event.id = \"4726\", _time)\n\n| fields xdm.event.id, xdm.event.original_event_type, xdm.target.user.username, xdm.source.user.username, user_principal_name, user_display_name, microsoft_windows_raw.event_data, *\n\n| comp earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.source.user.username) as activity_by_user, min(user_creation_time) as creation_time, max(user_deletion_time) as deletion_time, values(user_principal_name) as user_principal_name, values(user_display_name) as user_display_name, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product by xdm.target.user.username   \n| alter create_delete_time_diff = timestamp_diff(deletion_time, creation_time, \"MINUTE\")\n| filter create_delete_time_diff >= 0 and create_delete_time_diff <= 240  // in minutes  ", "is_enabled": true, "description": "Rule 44", "alert_name": "MSCAP - Short Lived Windows Accounts ACC (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "vendor", "_product": "product", "activity": "activity_by_user", "targetuser": "xdm.target.user.username", "deletiontime": "deletion_time", "sourceuserid": "activity_by_user", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "timedifference": "create_delete_time_diff", "userdisplayname": "user_display_name", "usercreationtime": "creation_time", "userprincipalname": "user_principal_name"}, "execution_mode": "SCHEDULED", "search_window": "8 hours", "simple_schedule": "custom", "timezone": "Australia/Sydney", "crontab": "0 */4 * * *", "suppression_enabled": true, "suppression_duration": "8 hours", "suppression_fields": ["xdm.target.user.username"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1136 - Create Account", "T1136.001 - Create Account: Local Account"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 47, "name": "MSCAP - Microsoft O365 SecurityComplianceCenter Alerts RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Microsoft O365 SecurityComplianceCenter Alerts RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_o365_general_raw\n// Date: 14/June/2024\n\nconfig case_sensitive = false\n| dataset = msft_o365_general_raw \n\n| filter Workload = \"securitycompliancecenter\"\n| filter Comments = \"new alert\"\n\n| filter Name not in (\"Email messages containing malicious URL removed after delivery\", \n\"activity from a password-spray associated ip address\", \"activity from a tor ip address\", \"activity from an anonymous proxy\", \n\"admin triggered user compromise investigation\", \"dlp-high volume of content detected australia financial data\", \n \"failed exact data match upload\", \"form blocked due to potential phishing attempt\", \n\"form flagged and confirmed as phishing\", \"messages containing malicious entity not removed after delivery\", \n\"potential nation-state activity\", \"powerbi administrative activity\", \"ransomware activity\", \"suspicious connector activity\", \n\"suspicious email deletion activity\", \"suspicious email sending patterns detected\", \n\"suspicious inbox manipulation\", \"suspicious tenant sending patterns observed\", \n\"tenant restricted from sending email\", \"tenant restricted from sending unprovisioned email\", \"unusual volume of external file sharing\", \n \"user restricted from sharing forms and collecting responses\", \"Email reported by user as malware or phish\", \"Email reported by user as junk\", \"Email reported by user as not junk\", \"Email messages containing malicious file removed after delivery\u200b\") \n\n| filter Operation not in (\"AlertEntityGenerated\", \"AlertUpdated\")\n\n| alter f3u = data -> f3u,\n        trc = data -> trc,\n        suid = data -> suid,\n        ad = data -> ad,\n        dm = data -> dm,\n        op = data -> op,\n        lon = data -> lon,\n        tht = data -> tht\n\n| alter user = coalesce(f3u, trc, suid),\n        detection_description = coalesce(ad, dm),\n        signature = coalesce(tht, op, lon)\n\n| replacenull detection_description = Name, signature = Name, Id = \"missing\", AlertId = \"missing\", user = \"missing\"\n\n| alter action = if(ResultStatus = \"succeeded\", \"success\", \n                ResultStatus in (\"invalid\", \"cancelled\", \"interrupted\"), \"error\", \n                ResultStatus = \"failed\", \"failure\", \n                ResultStatus = \"pending\", \"pending\", \n                \"missing\")\n\n| comp count() as total_event, earliest(CreationTime) as first_event_time, latest(CreationTime) as last_event_time, values(user) as user, values(_vendor) as vendor, values(_product) as product, values(ResultStatus) as detection_action, values(action) as action, values(operation) as detection_operation, values(signature) as signature, values(detection_description) as detection_description, values(Category) as category, values(Severity) as severity, values(Source) as source, values(RelativeUrl) as resources, values(EntityType) as entityType, values(Id) as Id by Name, AlertId, Workload, Comments, AlertLinks \n\n| fields total_event, first_event_time, last_event_time, user, detection_description, AlertId, Id, Comments as detection_status, action, Severity, Workload as vendor_product, resources, source, detection_operation, Name as detection_title, AlertLinks , signature, entityType, detection_action, category, vendor, product", "is_enabled": true, "description": "Rule 18", "alert_name": "MSCAP - Microsoft O365 SecurityComplianceCenter Alerts RAW (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"title": "detection_title", "source": "source", "_vendor": "vendor", "comment": "detection_status", "_product": "product", "lastseen": "last_event_time", "severity": "severity", "firstseen": "first_event_time", "resources": "resources", "signature": "signature", "entitytype": "entityType", "alertaction": "detection_action", "eventaction": "action", "detectionurl": "resources", "operationname": "detection_operation", "alert_category": "category", "originalalertid": "AlertId", "eventdescriptions": "detection_description", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["AlertId", "detection_title"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1078.004 - Valid Accounts: Cloud Accounts"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 50, "name": "MSCAP - Azure AAD User Enabled from Disabled State RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure AAD User Enabled from Disabled State RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_audit_raw\n// Date: 14/June/2024\n\n/*\nAlert Suppression : 8h\nSuppression Fields : userPrincipalName, activity_by_user\n\nFields Mapping:\nUsername : user\nEvent Action : action\nCategory : category\nLast Modified On : last_seen_disabled\nOperation Name : operationType\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_audit_raw\n\n| alter modified_properties = json_extract_array(targetResources, \"$.0.modifiedProperties\")\n\n| alter type = json_extract_scalar(targetResources, \"$.0.type\")\n| filter type = \"User\"\n| alter account_enabled = arraymap(modified_properties, if(\"@element\" -> displayName = \"accountEnabled\", true))\n| filter account_enabled = true\n\n| filter result = \"success\"\n\n| alter previous_status = arraymap(modified_properties, if(\"@element\" -> displayName = \"accountEnabled\", \"@element\" -> oldValue))\n| filter previous_status contains \"false\"\n| alter current_status = arraymap(modified_properties, if(\"@element\" -> displayName = \"accountEnabled\", \"@element\" -> newValue))\n| filter current_status contains \"true\"\n\n| alter activity_by_user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\")\n\n| alter userPrincipalName = json_extract_scalar(targetResources, \"$.0.userPrincipalName\")\n| replacenull userPrincipalName = \"missing\"\n| filter activity_by_user != \"Sync_BSSOND02_1a4ebc93591d@otmlhome.onmicrosoft.com\"\n\n| comp min(activityDateTime) as last_seen_disabled, values(activityDisplayName) as action by userPrincipalName, activity_by_user, result, operationType, category\n", "is_enabled": true, "description": "Rule 52", "alert_name": "MSCAP - Azure AAD User Enabled from Disabled State RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"activity": "activity_by_user", "eventaction": "action", "operationname": "operationType", "operationtype": "operationType", "alert_category": "category", "lastmodifiedon": "last_seen_disabled", "userprincipalname": "userPrincipalName", "actor_effective_username": "userPrincipalName"}, "execution_mode": "SCHEDULED", "search_window": "5 hours", "simple_schedule": "custom", "timezone": "Asia/Calcutta", "crontab": "0 */4 * * *", "suppression_enabled": true, "suppression_duration": "8 hours", "suppression_fields": ["userPrincipalName", "activity_by_user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1078.004 - Valid Accounts: Cloud Accounts"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 51, "name": "MSCAP - Azure Active Directory Risky Sign-in RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure Active Directory Risky Sign-in RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_azure_ad_raw\n// Date: 14/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : userDisplayName, userPrincipalName, src_ip, signature\nFields Mapping:\nUsername : userDisplayName\nUser Id : userPrincipalName\nFirst Seen : first_event_time\nLast Seen : last_event_time\nRemote Ip : src_ip\nlocation : location\nSrc OS : operating_system\nError Code : error_code\nAdditional Data : additional_details\nSignature : signature\nSeverity : severity\n*/\n\nconfig case_sensitive = false\n| dataset = msft_azure_ad_raw\n| filter riskState = \"atrisk\"\n\n| alter error_code = status -> errorCode, additional_details = status -> additionalDetails\n| alter browser = deviceDetail -> browser, os = deviceDetail -> operatingSystem\n| alter city = location -> city, country = location -> countryOrRegion, state = location -> state\n| alter location = format_string(\"%s | %s | %s\", city, state, country)\n\n| replacenull userId = \"missing\", userDisplayName = \"missing\", riskDetail = \"missing\", riskEventTypes = \"missing\", additionalData = \"missing\"\n\n| filter Location !=\"*| AU\"\n| filter location !=\"*| PG\"\n\n\n| comp count() as total_events, min(createdDateTime) as first_event_time, max(createdDateTime) as last_event_time, values(location) as location, values(browser) as browser, values(os) as operating_system, values(riskDetail) as risk_detail, values(additional_details) as additional_details, values(error_code) as error_code, values(ipAddress) as src_ip, values(riskEventTypes)  as signature, values(riskLevelDuringSignIn) as severity by userDisplayName, userPrincipalName, riskState", "is_enabled": true, "description": "Rule 45", "alert_name": "MSCAP - Azure Active Directory Risky Sign-in RAW (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"srcos": "operating_system", "userid": "userPrincipalName", "lastseen": "last_event_time", "location": "location", "severity": "severity", "errorcode": "error_code", "firstseen": "first_event_time", "signature": "signature", "additionaldata": "additional_details", "action_local_ip": "src_ip", "userdisplayname": "userDisplayName", "action_remote_ip": "src_ip", "actor_effective_username": "userPrincipalName"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["src_ip", "userDisplayName", "userPrincipalName", "signature"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": [], "TA0001 - Initial Access": ["T1078.004 - Valid Accounts: Cloud Accounts"], "TA0005 - Defense Evasion": [], "TA0004 - Privilege Escalation": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 52, "name": "MSCAP - Tenable Compromised Host Detection RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Tenable Compromised Host Detection RAW (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 14/June/2024\r\n\r\ndatamodel dataset = tenable_io_vulnerabilities_raw\r\n| alter \r\n    signature = json_extract_scalar(tenable_io_vulnerabilities_raw.plugin,\"$.synopsis\"),\r\n    port = json_extract_scalar(tenable_io_vulnerabilities_raw.port,\"$.port\"),\r\n    last_detected = format_timestamp(\"%ft%t%:z\", tenable_io_vulnerabilities_raw.last_found),\r\n    xdm.target.host.ipv4_addresses = arraystring(xdm.target.host.ipv4_addresses, \"|\"),\r\n    xdm.target.host.ipv6_addresses = arraystring(xdm.target.host.ipv6_addresses, \"|\")\r\n\r\n| fields *, xdm.alert.category as detection_family, xdm.alert.severity as detection_severity, xdm.alert.description as description,xdm.alert.name as detection_name,xdm.alert.original_alert_id as detection_id,xdm.event.description as detection_output, tenable_io_vulnerabilities_raw.severity_modification_type as severity_modification_type\r\n| filter \r\n    detection_severity != \"informational\" and xdm.target.host.ipv4_addresses not in (\"bvmswhp01\", \"10.10.144.10\", \"btenwh01\",\"bvmsppp01\", \"10.40.144.12\", \"btenpp01\",\"bvmsndp01\", \"10.50.144.10\", \"btenb201\",\"bnesswh01\", \"10.10.143.21\", \"btenwh02\",\"btenmi01\", \"10.25.144.10\") and (severity_modification_type != \"accepted\") and xdm.target.host.ipv6_addresses not in (\"bvmswhp01\", \"10.10.144.10\", \"btenwh01\",\"bvmsppp01\", \"10.40.144.12\", \"btenpp01\",\"bvmsndp01\", \"10.50.144.10\", \"btenb201\",\"bnesswh01\", \"10.10.143.21\", \"btenwh02\",\"btenmi01\", \"10.25.144.10\") and\r\n    (detection_family=\"backdoors\" and signature=\"*\") or\r\n    (detection_family=\"*\" and signature=\"implant\") or\r\n    (detection_family=\"web servers\" and signature=\"backdoor detection\") or \r\n    (detection_family=\"*\" and signature=\"*malicious process detection*\") \r\n    \r\n\r\n| comp \r\n    values(xdm.observer.type) as orig_sourcetype, \r\n    values(xdm.observer.name ) as orig_host, //_collector_name\r\n    values(detection_family) as detection_family, \r\n    values(detection_name) as detection_name, \r\n    values(description) as description, \r\n    values(port) as port, \r\n    values(detection_severity) as detection_severity, \r\n    values(detection_output) as detection_output, \r\n    values(_vendor) as vendor, \r\n    values(_product) as vendor_product, \r\n    count(), earliest(_time) as first_event_time, latest(_time) as last_event_time \r\n    by signature, xdm.target.host.fqdn\r\n\r\n/*acceptrisk, plugin.solution, solution fields not found\r\nport.service field not found and doesn't exist in Splunk Tenable addon either\r\n src_ip=if(isnotnull(ipv4), ipv4, ipv6) - ipv4 and ipv6 are mapped to src_ip in SPL, however, in Splunk addon, it is mapped to dest_ip\r\n*/", "is_enabled": true, "description": "Rule 26", "alert_name": "MSCAP - Tenable Compromised Host Detection RAW (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"port": "port", "_vendor": "vendor", "signature": "signature", "description": "description", "originalhost": "orig_host", "destinationip": "xdm.target.host.fqdn", "detectionname": "detection_name", "lasteventtime": "last_event_time", "vendorproduct": "vendor_product", "firsteventtime": "first_event_time", "destinationipv6": "first_event_time", "detectionfamily": "first_event_time", "detectionoutput": "detection_output", "detectionseverity": "detection_severity", "originalsourcetype": "orig_sourcetype"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["detection_name", "signature", "port", "detection_output", "detection_severity", "detection_family", "xdm.target.host.fqdn"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 54, "name": "MSCAP - Windows Domain Trust Modification via Windows Event Code RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Windows Domain Trust Modification via Windows Event Code RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 17/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.event.id, signature, xdm.event.original_event_type, user\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id in (\"4706\", \"4707\", \"4716\")\n| alter signature = if(xdm.event.id = \"4706\", \"a new trust was created to a domain.\", xdm.event.id = \"4707\", \"a trust to a domain was removed.\", xdm.event.id = \"4716\", \"trusted domain information was modified.\")\n| replacenull xdm.source.ipv4 = \"missing\", xdm.source.user.username = \"missing\"\n| fields xdm.event.id, signature, xdm.event.original_event_type, xdm.source.ipv4, xdm.source.user.username, microsoft_windows_raw.event_data, *\n\n| comp count() as total_events, min(_time) as first_event_time, max(_time) as last_event_time, values(xdm.source.user.domain) as src_nt_domain, values(xdm.source.user.username) as user, values(xdm.source.host.hostname) as host, values(xdm.observer.product) as product, values(xdm.observer.vendor) as vendor by xdm.event.id, signature, xdm.event.original_event_type", "is_enabled": true, "description": "Rule 56", "alert_name": "MSCAP - Windows Domain Trust Modification via Windows Event Code RAW (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"eventid": "xdm.event.id", "signature": "signature", "totalevents": "total_events", "sourcedomain": "src_nt_domain", "lasteventtime": "last_event_time", "agent_hostname": "host", "firsteventtime": "first_event_time", "action_local_ip": null, "action_remote_ip": null, "originaleventtype": "xdm.event.original_event_type", "action_remote_port": null, "agent_device_domain": "src_nt_domain", "actor_effective_username": "user", "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.event.id", "xdm.event.original_event_type", "signature", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0005 - Defense Evasion": [], "TA0004 - Privilege Escalation": ["T1484.002 - Domain Policy Modification: Domain Trust Modification"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 55, "name": "MSCAP - Service Account or Non Domain Admin RDP Login to Domain Controller RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Service Account or Non Domain Admin RDP Login to Domain Controller RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 18/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.source.ipv4, xdm.target.user.username\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id = \"4624\"\n| filter xdm.logon.type = \"REMOTE_INTERACTIVE\"\n\n// dest_priority and user_category field not found\n// filter dest_priority = \"critical\"\n// filter user_category != \"domain admins\" or user_category = \"dont_expire_password\"\n\n| replacenull xdm.source.ipv4 = \"missing\", xdm.target.user.username = \"missing\"\n| filter xdm.source.host.hostname contains \"DC\"\n| filter xdm.target.user.username not contains \"priv.\"\n\n| comp count() as total_event, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.observer.product) as product, values(xdm.observer.vendor) as vendor by xdm.source.host.hostname, xdm.source.ipv4, xdm.target.user.username, xdm.event.original_event_type  // dest_priority, user_category", "is_enabled": true, "description": "Rule 37", "alert_name": "MSCAP - Service Account or Non Domain Admin RDP Login to Domain Controller RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"sourceip": "xdm.source.ipv4", "sourcehost": "xdm.source.host.hostname", "targetuser": "xdm.target.user.username", "totalevents": "total_event", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "originaleventtype": "xdm.event.original_event_type"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.target.user.username", "xdm.source.ipv4"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0008 - Lateral Movement": ["T1021.001 - Remote Services: Remote Desktop Protocol"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 56, "name": "MSCAP - Detect Attempted Exploitation of Microsoft CVE-2020-1472 Netlogon RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Detect Attempted Exploitation of Microsoft CVE-2020-1472 Netlogon RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 18/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id in (\"5827\", \"5828\", \"5829\", \"5830\", \"5831\") \n\n// | filter name = \"netlogon\" // no mapping know for name field\n\n| replacenull xdm.source.ipv4 = \"missing\"\n\n| alter signature = if(xdm.event.id = \"5827\", \"the netlogon service denied a vulnerable netlogon secure channel connection from a machine account.\",\n    xdm.event.id = \"5828\", \"the netlogon service denied a vulnerable netlogon secure channel connection using a trust account.\",\n    xdm.event.id = \"5829\", \"the netlogon service allowed a vulnerable netlogon secure channel connection.\",\n    xdm.event.id = \"5830\", \"the netlogon service allowed a vulnerable netlogon secure channel connection because the machine account is allowed in the domain controller: allow vulnerable netlogon secure channel connections group policy.\",\n    xdm.event.id = \"5831\", \"the netlogon service allowed a vulnerable netlogon secure channel connection because the trust account is allowed in the domain controller: allow vulnerable netlogon secure channel connections group policy.\")\n\n| alter src_domain = json_extract_scalar(microsoft_windows_raw.event_data, \"$.domain\"), machine_sam_account_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.machineSamAccountName\"), account_type = json_extract_scalar(microsoft_windows_raw.event_data, \"$.accountType\"), os = json_extract_scalar(microsoft_windows_raw.event_data, \"$.os\"), os_build = json_extract_scalar(microsoft_windows_raw.event_data, \"$.osBuild\"),  os_service_pack = json_extract_scalar(microsoft_windows_raw.event_data, \"$.osServicePack\")\n\n| comp count() as total_events, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, values(os) as extracted_os, values(os_build) as extracted_os_build, values(os_service_pack) as extracted_os_service_pack, values(src_domain) as extracted_src_domain, values(xdm.source.ipv4) as src, values(xdm.source.host.hostname) as host, values(machine_sam_account_name) as extracted_src by xdm.event.id, signature, xdm.event.original_event_type \n\n// data fetch from event_data as per assumption but corect data path to be validated once we have data available for the event ids.\n", "is_enabled": true, "description": "Rule No  8 -  data source is not ready to test", "alert_name": "MSCAP - Detect Attempted Exploitation of Microsoft CVE-2020-1472 Netlogon RAW (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "host", "source": "src", "_vendor": "vendor", "eventid": "xdm.event.id", "osbuild": "extracted_os_build", "_product": "product", "signature": "signature", "extractedos": "extracted_os", "totalevents": "total_events", "lasteventtime": "last_event_time", "osservicepack": "extracted_os_service_pack", "agent_hostname": null, "firsteventtime": "first_event_time", "action_local_ip": null, "extractedsource": "extracted_src", "action_remote_ip": null, "action_remote_port": null, "agent_device_domain": null, "actor_effective_username": null, "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.event.id", "src", "signature", "host", "extracted_src_domain", "extracted_src", "extracted_os", "extracted_os_build", "extracted_os_service_pack"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0005 - Defense Evasion": [], "TA0004 - Privilege Escalation": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 57, "name": "MSCAP - Common Abused Remote Access Windows Startup Items - Tenable RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Common Abused Remote Access Windows Startup Items - Tenable RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: tenable_io_vulnerabilities_raw\n// Date: 18/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.alert.name, src_ip, detection_output\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = tenable_io_vulnerabilities_raw \n\n| filter xdm.alert.name = \"microsoft windows startup software enumeration\"\n| filter xdm.event.description in (\"*anydesk*\", \"*teamviewer*\", \"*logmein*\", \"*connectwise*\", \"*screenconnect*\", \"*mremoteng*\", \"*gotoassist*\", \"*zoho assist*\", \n\"*beyondtrust remote*\", \"*realvnc*\", \"*vnc connect*\", \"*tightvnc*\", \"*ultravnc*\", \"*bomgar*\", \"*splashtop*\", \"*atera*\", \"*supremo*\", \"*awesun*\")\n\n| alter detection_solution = json_extract_scalar(tenable_io_vulnerabilities_raw.plugin, \"$.solution\"), detection_family = json_extract_scalar(tenable_io_vulnerabilities_raw.plugin, \"$.family\")\n| alter ipv4 = json_extract_scalar(tenable_io_vulnerabilities_raw.asset, \"$.ipv4\"), ipv6 = json_extract_scalar(tenable_io_vulnerabilities_raw.asset, \"$.ipv6\")\n\n\n\n// macros logic\n| filter ipv4 not in (\"bvmswhp01\", \"10.10.144.10\", \"btenwh01\",\"bvmsppp01\", \"10.40.144.12\", \"btenpp01\",\"bvmsndp01\", \"10.50.144.10\", \"btenb201\",\"bnesswh01\", \"10.10.143.21\", \"btenwh02\",\"btenmi01\", \"10.25.144.10\")\n| filter ipv6 not in (\"bvmswhp01\", \"10.10.144.10\", \"btenwh01\",\"bvmsppp01\", \"10.40.144.12\", \"btenpp01\",\"bvmsndp01\", \"10.50.144.10\", \"btenb201\",\"bnesswh01\", \"10.10.143.21\", \"btenwh02\",\"btenmi01\", \"10.25.144.10\")\n\n\n\n//Filter \n|filter ipv4 NOT IN (\"10.64.180.131\", \"10.45.19.10\") AND detection_solution != \"*TightVNC*\" //Filtering TightVNC from this detection\n|filter ipv4 NOT IN (\"10.64.180.118\", \"10.64.180.201\", \"10.15.20.128\", \"10.25.22.32\", \"10.20.20.112\", \"10.64.180.163\") //Filtering as per Splunk request.\n\n| alter src_ip = if(ipv4 in (null, \"\"), ipv6, ipv4)\n| comp count() as total_events, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(xdm.target.host.hostname) as host, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, values(detection_family) as detection_family, values(xdm.target.host.os) as os, values(xdm.alert.description) as description, values(detection_solution) as detection_solution, values(xdm.alert.severity) as detetction_severity, values(xdm.target.host.fqdn) as host_fqdn, values(xdm.event.description) as detection_output by xdm.alert.name, src_ip", "is_enabled": true, "description": "Rule 40", "alert_name": "MSCAP - Common Abused Remote Access Windows Startup Items - Tenable RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"os": "os", "_vendor": "vendor", "_product": "product", "sourceip": "src_ip", "agent_fqdn": "host_fqdn", "alert_name": "xdm.alert.name", "description": "description", "totalevents": "total_events", "lasteventtime": "last_event_time", "agent_hostname": "host", "firsteventtime": "first_event_time", "detectionfamily": "detection_family", "detectionoutput": "detection_output", "detectionseverity": "detetction_severity", "detectionsolution": "detection_solution"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.alert.name", "src_ip", "detection_output"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0008 - Lateral Movement": ["T1021.005 - Remote Services: VNC"], "TA0011 - Command and Control": ["T1219 - Remote Access Software"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 58, "name": "MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 19/June/2024\r\n\r\ndatamodel dataset in (microsoft_windows_raw,msft_o365_azure_ad_raw)\r\n|filter xdm.event.outcome = XDM_CONST.OUTCOME_SUCCESS \r\n|comp values(xdm.source.host.hostname) as host, values(_product) as vendor_product, values(_vendor) as vendor, values(xdm.target.ipv4) as dest, values(xdm.observer.product) as sourcetype by xdm.source.user.username, _time, xdm.source.ipv4//, authentication.signature span=1s \r\n| iploc xdm.source.ipv4 loc_continent AS Continent, loc_country AS Country, loc_region AS Region, loc_city AS City, loc_latlon AS lon\r\n| comp count_distinct(lon) as location_count by xdm.source.user.username, xdm.source.ipv4\r\n| filter location_count > 1\r\n", "is_enabled": true, "description": "Rule 10", "alert_name": "MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen", "alert_category": "DISCOVERY", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.source.ipv4", "xdm.source.user.username"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1078 - Valid Accounts", "T1078.001 - Valid Accounts: Default Accounts", "T1078.002 - Valid Accounts: Domain Accounts", "T1078.003 - Valid Accounts: Local Accounts", "T1078.004 - Valid Accounts: Cloud Accounts"], "TA0042 - Resource Development": ["T1584 - Compromise Infrastructure", "T1584.001 - Compromise Infrastructure: Domains", "T1584.002 - Compromise Infrastructure: DNS Server", "T1584.003 - Compromise Infrastructure: Virtual Private Server", "T1584.004 - Compromise Infrastructure: Server", "T1584.005 - Compromise Infrastructure: Botnet", "T1584.006 - Compromise Infrastructure: Web Services"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "AUTO", "action": "ALERTS", "lookup_mapping": null}, {"rule_id": 59, "name": "MSCAP - High Risk URL Categories ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - High Risk URL Categories ACC (CCX) - Summary Gen\n/// Author: Deven Amode, damode@paloaltonetworks.com\n// Date: 06/June/2024\n\ndataset in  (panw_ngfw_traffic_raw,panw_ngfw_threat_raw,panw_ngfw_url_raw,panw_ngfw_tunnel_raw,panw_ngfw_filedata_raw,panw_ngfw_system_raw,panw_ngfw_globalprotect_raw,panw_ngfw_hipmatch_raw)\n\n| join (dataset=high_risk_url_category_list_by_vendor_lookup | fields url_category, vendor_name) as high_risk_url_category_list_by_vendor_lookup (high_risk_url_category_list_by_vendor_lookup.url_category = url_category) AND (high_risk_url_category_list_by_vendor_lookup.vendor_name = vendor_name)\n\n| filter if(url_category != null, true, false) = true\n\n| filter url_domain not in  (\"checkip.dyndns.org\", \"*.icloud.com\")\n| replacenull uri = \"missing\"\n| filter action = \"alert\"\n\n| filter url_category != \"parked\"\n| filter uri != \"missing\"\n\n\n| comp earliest(_time) as first_time, latest(_time) as last_time, values(url_category ) as url_Category, values(uri) as url, values(action) as action, values(dest_port) as dest_port, count() by users, source_ip, dest_ip, _log_type ", "is_enabled": true, "description": "Rule 2", "alert_name": "MSCAP - High Risk URL Categories ACC (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"user": "users", "sourceip": "source_ip", "urlcategory": "url_Category", "detectionurl": "url", "originalhost": "source_ip", "destinationip": "dest_ip", "fw_url_domain": "url", "lasteventtime": "last_time", "firsteventtime": "first_time", "destinationport": "dest_port"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["first_time", "last_time", "url_Category", "url", "action", "dest_port", "users", "source_ip", "dest_ip", "_log_type"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0011 - Command and Control": ["T1071.001 - Application Layer Protocol: Web Protocols"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 60, "name": "MSCAP - O365 New Inbox Rule RAW (CCX) - Summary Gen", "severity": "SEV_010_INFO", "xql_query": "// Title: MSCAP - O365 New Inbox Rule RAW (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Date: 13/June/2024\r\n\r\nconfig case_sensitive = false\r\n| dataset = msft_o365_exchange_online_raw \r\n| filter operation = \"new-inboxrule\" and  ResultStatus=\"true\"\r\n| fields  ResultStatus as status, _time, UserId as user, Parameters,  operation as action, _reporting_device_name as orig_host, _collector_type,  ClientIP as src,_product,_vendor ", "is_enabled": true, "description": "Rule 60 - Downgraded to informational to only see this event when associated to other IOCs", "alert_name": "MSCAP - O365 New Inbox Rule RAW (CCX) - Summary Gen", "alert_category": "COLLECTION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"_vendor": "_vendor", "parameters": "Parameters", "description": "Parameters", "eventaction": "action", "originalraw": "_raw_log", "originalhost": "orig_host", "sourcestatus": "status", "vendorproduct": "_product", "agent_hostname": "orig_host", "action_local_ip": "src", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["action", "orig_host", "src", "status", "user"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0009 - Collection": ["T1114.003 - Email Collection: Email Forwarding Rule"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 61, "name": "MSCAP - Azure Modified Domain Federation Trust Settings RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Azure Modified Domain Federation Trust Settings RAW (CCX) - Summary Gen\r\n// Author: Deven Amode, damode@paloaltonetworks.com\r\n// Datasets: msft_azure_ad_audit_raw\r\n// Date: 11/June/2024\r\n\r\nconfig case_sensitive = false\r\n| dataset = msft_azure_ad_audit_raw \r\n| filter activityDisplayName = \"*set federation settings on domain*\" and result = \"success\"\r\n\r\n| alter \r\n    user = json_extract_scalar(initiatedBy, \"$.user.userPrincipalName\"),\r\n    src = json_extract_scalar(initiatedBy, \"$.user.ipAddress\"),\r\n    app = json_extract_scalar(targetResources, \"$.0.displayName\"),\r\n    user_type = json_extract_scalar(targetResources, \"$.0.type\")\r\n\r\n| fields  _time, app, user, user_type, activityDisplayName as signature, _collector_type , _vendor, _product", "is_enabled": true, "description": "Rule 67", "alert_name": "MSCAP - Azure Modified Domain Federation Trust Settings RAW (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "usertype": "user_type", "signature": "signature", "actor_effective_username": "user"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["user", "app", "signature", "user_type", "_insert_time"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0004 - Privilege Escalation": ["T1134.003 - Access Token Manipulation: Make and Impersonate Token"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 62, "name": "MSCAP - O365 Add App Role Assignment Grant User RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - O365 Add App Role Assignment Grant User RAW (CCX) - Summary Gen\n// Author: Jorge Ramirez, jramirez@cybercx.com\n// Date: 30/August/2024\n\n\nconfig case_sensitive = false\n| dataset = msft_o365_azure_ad_raw\n\n| alter User_Actor = json_extract_scalar(Actor, \"$.0.ID\") \n| alter App_Target_Name = json_extract_scalar(`Target` , \"$.3.ID\") \n| alter App_Target_ID = json_extract_scalar(`Target`, \"$.4.ID\")\n| alter Assigned_User = json_extract_scalar(ModifiedProperties , \"$.6.NewValue\")\n\n| filter Workload=\"AzureActiveDirectory\" AND Operation=\"Add app role assignment grant to user.\"\n\n| comp values(ResultStatus) as status, min(_time) as first_event_time, max(_time) as last_event_time, values(_vendor) as Vendor, values(_product ) as Product  by Actor, User_Actor, App_Target_Name , Assigned_User , Operation, App_Target_ID ", "is_enabled": true, "description": "Rule 34", "alert_name": "MSCAP - O365 Add App Role Assignment Grant User RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "App_Target_Name", "userid": "User_Actor", "actorid": "User_Actor", "_product": "Product", "eventaction": "Operation", "applicationid": "App_Target_ID", "lasteventtime": "last_event_time", "vendorproduct": "Vendor", "appdisplayname": "App_Target_Name", "firsteventtime": "first_event_time"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["status", "first_event_time", "last_event_time", "Vendor", "Product", "Actor", "User_Actor", "App_Target_Name", "Assigned_User"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1136 - Create Account", "T1136.003 - Create Account: Cloud Account"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 63, "name": "MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen\n// Author: Deven Amode, damode@paloaltonetworks.com\n// Date: 19/June/2024\n\ndatamodel dataset in (microsoft_windows_raw,msft_o365_azure_ad_raw)\n|filter xdm.event.outcome = XDM_CONST.OUTCOME_SUCCESS \n|comp values(xdm.source.host.hostname) as host, values(_product) as vendor_product, values(_vendor) as vendor, values(xdm.target.ipv4) as dest, values(xdm.observer.product) as sourcetype by xdm.source.user.username, _time, xdm.source.ipv4//, authentication.signature span=1s \n| iploc xdm.source.ipv4 loc_continent AS Continent, loc_country AS Country, loc_region AS Region, loc_city AS City, loc_latlon AS lon\n| comp count_distinct(lon) as location_count , values(Country) as Countries by xdm.source.user.username, xdm.source.ipv4\n| filter location_count > 1\n", "is_enabled": true, "description": "Rule 10", "alert_name": "MSCAP - Geographically Improbable Access ACC (CCX) - Summary Gen", "alert_category": "COLLECTION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"sourceip": "xdm.source.ipv4", "locationcount": "location_count", "action_country": "Countries", "actor_effective_username": "xdm.source.user.username"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.source.user.username", "xdm.source.ipv4", "location_count"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0001 - Initial Access": ["T1078.001 - Valid Accounts: Default Accounts", "T1078.002 - Valid Accounts: Domain Accounts", "T1078.003 - Valid Accounts: Local Accounts", "T1078.004 - Valid Accounts: Cloud Accounts"], "TA0042 - Resource Development": ["T1584 - Compromise Infrastructure", "T1584.001 - Compromise Infrastructure: Domains", "T1584.002 - Compromise Infrastructure: DNS Server", "T1584.003 - Compromise Infrastructure: Virtual Private Server", "T1584.004 - Compromise Infrastructure: Server", "T1584.005 - Compromise Infrastructure: Botnet", "T1584.006 - Compromise Infrastructure: Web Services"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 64, "name": "Silverlight Fortnightly report", "severity": "SEV_020_LOW", "xql_query": "// Title: Silverlight Fortnightly report\n// Description: Report for Joanna Field to review \n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: tenable_io_vulnerabilities_raw\n// Date: 25/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = tenable_io_vulnerabilities_raw \n| filter xdm.alert.name = \"*silverlight*\"\n| filter xdm.source.host.fqdn not in (\"\", null)\n\n| alter state = tenable_io_vulnerabilities_raw.state, \n        cvss3_base_score = json_extract_scalar(tenable_io_vulnerabilities_raw.plugin, \"$.cvss_base_score\")\n\n| filter state in (\"OPEN\", \"REOPENED\")\n| replacenull cvss3_base_score = \"NULL\"\n| alter pluginAndCVEState = format_string(\"%s CVSS3: %s %s\", xdm.alert.name, cvss3_base_score, state)\n\n| fields tenable_io_vulnerabilities_raw.plugin, xdm.alert.name, xdm.source.host.fqdn, state, cvss3_base_score, pluginAndCVEState, *\n| comp count() as total_events, min(_time) as s_time, max(_time) as e_time, values(xdm.alert.severity) as severity, values(xdm.event.description) as output, values(xdm.alert.description) as description, values(pluginAndCVEState) as pluginAndCVEState, values(xdm.alert.name) as plugin_name, values(cvss3_base_score) as cvss3_score, values(state) as state by xdm.source.host.fqdn\n\n| fields pluginAndCVEState, cvss3_score, state, xdm.source.host.fqdn as asset_fqdn, s_time, e_time, severity", "is_enabled": true, "description": "Rule 75", "alert_name": "Silverlight Fortnightly report", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"state": "state", "cvestate": "pluginAndCVEState", "severity": "severity", "cvssscore": "cvss3_score", "lasteventtime": "e_time", "agent_hostname": "asset_fqdn", "firsteventtime": "s_time"}, "execution_mode": "SCHEDULED", "search_window": "7 days", "simple_schedule": "custom", "timezone": "Asia/Calcutta", "crontab": "15 8 1,15 * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["pluginAndCVEState", "cvss3_score", "state", "asset_fqdn", "s_time", "e_time", "severity"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 65, "name": "MSANA - Service Logic Monitor Added to Admin Group (CS0057691) (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSANA - Service Logic Monitor Added to Admin Group (CS0057691) (CCX) - Summary Gen\n// Description: report when logic Monitor is added to an administrator work, as Logic Monitor should not have this capability\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 25/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.event.id, xdm.event.original_event_type, xdm.source.user.username, xdm.source.user.domain, xdm.target.user.username, xdm.target.user.domain, xdm.source.host.hostname\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw  \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id = \"4728\"\n| filter xdm.target.user.username = \"*admin*\"\n\n| alter member_name = json_extract_scalar(microsoft_windows_raw.event_data, \"$.MemberName\")\n| filter member_name = \"*logicmonitor*\"\n\n// extract user from DN\n| alter membername = replace(json_extract_scalar(microsoft_windows_raw.event_data, \"$.MemberName\"), \"\\,\", \" \")\n| alter user = arrayindex(regextract(membername, \"CN=([^,]+)\"), 0)\n\n| comp count() as total_event, min(_time) as first_event_time, max(_time) as last_event_time, values(member_name) as member_name, values(user) as user by xdm.event.id, xdm.event.original_event_type, xdm.source.user.username, xdm.source.user.domain, xdm.target.user.username, xdm.target.user.domain, xdm.source.host.hostname", "is_enabled": true, "description": "Rule 77", "alert_name": "MSANA - Service Logic Monitor Added to Admin Group (CS0057691) (CCX) - Summary Gen", "alert_category": "PRIVILEGE_ESCALATION", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"eventid": "xdm.event.id", "membername": "member_name", "targetuser": "xdm.target.user.username", "totalevents": "total_event", "targetdomain": "xdm.target.user.domain", "usersdetails": "user", "lasteventtime": "last_event_time", "agent_hostname": "xdm.source.host.hostname", "firsteventtime": "first_event_time", "action_local_ip": null, "action_remote_ip": null, "originaleventtype": "xdm.event.original_event_type", "action_remote_port": null, "agent_device_domain": "xdm.target.user.domain", "actor_effective_username": "xdm.target.user.username", "actor_process_image_name": null, "actor_process_image_path": null, "actor_process_command_line": null, "actor_process_image_sha256": null}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.event.id", "xdm.event.original_event_type", "xdm.source.user.domain", "xdm.source.user.username", "xdm.target.user.domain", "xdm.target.user.username", "xdm.source.host.hostname"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": [], "TA0004 - Privilege Escalation": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 66, "name": "MSCAP - User Added or Removed From Privileged Group RAW (CCX) - Summary Gen", "severity": "SEV_020_LOW", "xql_query": "// Title: MSCAP - User Added or Removed From Privileged Group RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 17/June/2024\n\nconfig case_sensitive = false\n| datamodel dataset = microsoft_windows_raw \n| filter xdm.source.host.os_family = XDM_CONST.OS_FAMILY_WINDOWS \n| filter xdm.event.id in (\"4727\", \"4728\", \"4729\", \"4730\", \"4731\", \"4732\", \"4733\", \"4734\", \"4735\", \"4737\", \"4754\", \"4755\", \"4756\", \"4757\", \"4758\", \"4764\")  \n\n| filter xdm.target.user.username not in (\"\", null)\n| filter xdm.target.user.domain != \"Builtin\"\n\n| filter xdm.event.id != \"4735\" and xdm.source.user.username != \"*$\"\n\n| alter membername = replace(json_extract_scalar(microsoft_windows_raw.event_data, \"$.MemberName\"), \"\\,\", \" \")\n\n| replacenull xdm.source.user.username = \"missing\"\n| filter xdm.source.user.username!=\"priv*\"\n\n| comp count() as total_event, min(_time) as first_event_time, max(_time) as last_event_time, values(xdm.source.host.hostname) as host, values(xdm.observer.vendor) as vendor, values(xdm.observer.product) as product, values(xdm.target.user.username) as group_name, values(membername) as member_name, values(xdm.source.user.username) as user by xdm.event.id, xdm.event.original_event_type, xdm.event.description", "is_enabled": true, "description": "Rule 24", "alert_name": "MSCAP - User Added or Removed From Privileged Group RAW (CCX) - Summary Gen", "alert_category": "PERSISTENCE", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"host": "host", "_vendor": "vendor", "eventid": "xdm.event.id", "_product": "product", "groupname": "group_name", "membername": "member_name", "totalevents": "total_event", "lasteventtime": "last_event_time", "firsteventtime": "first_event_time", "originaleventtype": "xdm.event.original_event_type", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["group_name", "member_name", "user", "xdm.event.id", "xdm.event.original_event_type", "product"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0003 - Persistence": ["T1098.001 - Account Manipulation: Additional Cloud Credentials"]}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 69, "name": "[OTML] Mimecast Auditing Events CHG0034292", "severity": "SEV_020_LOW", "xql_query": "// Title: [OTML] Mimecast Auditing Events CHG0034292\n// Description: Report to OTML from audit policy changes in MimeCast sent to ICT-Enterprise-Systems@oktedi.com\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Date: 25/June/2024\n\nconfig case_sensitive = false \n| datamodel dataset = mimecast_mimecast_raw\n| filter xdm.event.type  in (\"*Adjustments\", \"*Adjustment\", \"*Log Entry\")\n| alter \n    //object_attrs = auditType ,\n    object =to_string(regextract(mimecast_mimecast_raw.eventInfo,\"(?:Application|App):\\s*([^,]+)\")),\n    object_category = if(xdm.event.type contains \"*user*\",\"user\", \"instance\"),\n    change_type = if(xdm.event.type contains \"*user*\",\"AAA\", \"filesystem\"),\n    signature = if (xdm.event.type contains \"*log*\" , xdm.event.type, \"virus\"),\n    action = mimecast_mimecast_raw.action,\n    eventdescription = xdm.event.description \n\n// Used both reason and eventInfo data to evaluate Action\n| alter action = if(action not in (\"\", null), action,\n                eventdescription contains \"Wrong Password\" or eventdescription contains \"Account locked\", \"Failure\",\n                eventdescription contains \"White URL created\", \"Created\",\n                eventdescription contains \"Successful\", \"Success\",\n                mimecast_mimecast_raw.eventInfo contains \"unlocked\", \"Unlocked\",\n                mimecast_mimecast_raw.eventInfo contains \"locked\", \"Lockout\",\n                mimecast_mimecast_raw.eventInfo contains \"updated\", \"Updated\",\n                mimecast_mimecast_raw.eventInfo contains \"delete\", \"Deleted\",\n                mimecast_mimecast_raw.eventInfo contains \"cleare\", \"Cleared\",\n                mimecast_mimecast_raw.eventInfo contains \"create\", \"Created\", \n                mimecast_mimecast_raw.eventInfo not in (\"\", null), \"Modified\", null)\n\n|fields mimecast_mimecast_raw.eventInfo , _time, xdm.source.user.username, object as app, xdm.event.type, change_type, object_category, eventdescription, action\n| comp count() as total_events, min(_time) as firstEventTime , max(_time) as lastEventTime by xdm.source.user.username, app, eventdescription, action, xdm.event.type, change_type, object_category", "is_enabled": true, "description": "Rule 76", "alert_name": "[OTML] Mimecast Auditing Events CHG0034292", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"app": "app", "changetype": "change_type", "eventaction": "action", "totalevents": "total_events", "lasteventtime": "lastEventTime", "firsteventtime": "firstEventTime", "objectcategory": "object_category", "eventdescription": "eventdescription", "originaleventtype": "xdm.event.type", "actor_effective_username": "xdm.source.user.username"}, "execution_mode": "SCHEDULED", "search_window": "3 days", "simple_schedule": "10 minutes", "timezone": "Australia/Brisbane", "crontab": "*/10 * * * *", "suppression_enabled": true, "suppression_duration": "1 minutes", "suppression_fields": ["total_events", "firstEventTime", "lastEventTime", "app", "eventdescription", "action", "change_type", "object_category", "xdm.source.user.username", "xdm.event.type"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 70, "name": "MSCAP - Thinkst Canary Incident Triggered - Graphical Login RAW (CCX) - Summary Gen", "severity": "SEV_050_CRITICAL", "xql_query": "// Title: MSCAP - Thinkst Canary Incident Triggered - Graphical Login RAW (CCX) - Summary Gen\n// Description: Alerts on Thinkst Canary incidents related to graphical logins\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: microsoft_windows_raw\n// Date: 26/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : summary, src_ip, dst_ip, user\nFields Mapping:\nLocal IP: src_ip\nLocal Port: src_port\nRemote IP: dst_ip\nRemote Port: dst_port\nUsername: user\nAlert Name: summary\nFirst Seen: first_event_time\nLast Seen: last_event_time\nAlert Type ID: alert_type\n*/\n\nconfig case_sensitive = false \n| dataset = thinkst_canary_generic_alert_raw \n| filter summary in (\"RDP Login Attempt\", \"WinRM Login Attempt\", \"VNC Login Attempt\")\n\n| alter \n    src_ip = description -> src_host, \n    src_port = description -> src_port, \n    dst_ip = description -> dst_host, \n    dst_port = description -> dst_port,\n    user = json_extract_scalar(description, \"$.events.0.USERNAME\"),\n    name = description -> name,\n    source_type = _alert_data -> alert_source,\n    alert_type = _alert_data -> alert_type,\n    host = description -> src_host_reverse\n\n| replacenull src_ip = \"MISSING\", dst_ip = \"MISSING\", user = \"MISSING\"\n\n| filter src_ip not in (\"bvmswhp01\", \"10.10.144.10\", \"btenwh01\", \"bvmsppp01\", \"10.40.144.12\", \"btenpp01\", \"bvmsndp01\", \"10.50.144.10\", \"btenb201\", \"bnesswh01\", \"10.10.143.21\", \"btenwh02\", \"btenmi01\", \"10.25.144.10\")\n\n| comp count() as total_events, earliest(_time) as first_event_time, latest(_time) as last_event_time, values(name) as name, values(source_type) as orig_sourcetype, values(alert_type) as alert_type, values(host) as orig_host, values(_vendor) as vendor, values(_product) as product, values(src_port) as src_port, values(dst_port) as dst_port by summary, src_ip, dst_ip, user ", "is_enabled": true, "description": "Rule 78", "alert_name": "MSCAP - Thinkst Canary Incident Triggered - Graphical Login RAW (CCX) - Summary Gen", "alert_category": "LATERAL_MOVEMENT", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"lastseen": "last_event_time", "firstseen": "first_event_time", "alert_name": "summary", "alerttypeid": "alert_type", "description": "name", "totalevents": "total_events", "lasteventtime": "last_event_time", "logsourcetype": "orig_sourcetype", "agent_hostname": "orig_host", "firsteventtime": "first_event_time", "action_local_ip": "src_ip", "action_remote_ip": "dst_ip", "action_local_port": "src_port", "action_remote_port": "dst_port", "actor_effective_username": "user"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["summary", "user", "src_ip", "dst_ip"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {"TA0008 - Lateral Movement": []}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 71, "name": "MSCAP - Multi Vendor Detection - Attacked Internal IP ACC (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Multi Vendor Detection - Attacked Internal IP ACC (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: panw_ngfw_threat_raw\n// Date: 27/June/2024\n\n/*\nAlert Suppression : 6h\nSuppression Fields : xdm.source.ipv4, xdm.target.ipv4\n*/\n\nconfig case_sensitive = false\n| datamodel dataset = panw_ngfw_threat_raw \n\n| join (\n    dataset = high_risk_url_category_list_by_vendor_lookup \n    | fields url_category, vendor_name\n) as high_risk_url high_risk_url.url_category = panw_ngfw_threat_raw.url_category \n\n| filter incidr(xdm.source.ipv4, \"10.0.0.0/8\") = true or \n        incidr(xdm.source.ipv4, \"172.16.0.0/12\") = true or \n        incidr(xdm.source.ipv4, \"192.168.0.0/16\") = true or \n        incidr(xdm.target.ipv4, \"10.0.0.0/8\") = true or \n        incidr(xdm.target.ipv4, \"172.16.0.0/12\") = true or \n        incidr(xdm.target.ipv4, \"192.168.0.0/16\") = true \n\n| filter incidr6(xdm.source.ipv6, \"fc00::/7\") = true or\n        incidr6(xdm.target.ipv6, \"fc00::/7\") = true\n\n| replacenull panw_ngfw_threat_raw.severity = \"missing\", xdm.observer.action = \"missing\", xdm.target.file.sha256 = \"missing\", panw_ngfw_threat_raw.threat_category = \"missing\"\n\n\n| comp count(panw_ngfw_threat_raw.threat_name) as attack_count, count_distinct(panw_ngfw_threat_raw.threat_name) as attack_dc, values(_vendor) as vendor, values(_product) as product, values(panw_ngfw_threat_raw.threat_name) as attack, min(_time) as first_event_time, max(_time) as last_event_time, values(panw_ngfw_threat_raw.threat_category) as category, values(panw_ngfw_threat_raw.severity) as severity, values(xdm.target.port) as dest_port, values(xdm.observer.action) as action, values(xdm.target.file.sha256) as file_hash, values(panw_ngfw_threat_raw.users) as user, values(panw_ngfw_threat_raw.cloud_hostname) as cloud_hostname by xdm.source.ipv4, xdm.target.ipv4\n\n// | filter attack_dc >= 3  // as of now this condition is not satisfed. So do we have to filter for 3 or more attacks", "is_enabled": true, "description": "Rule 20", "alert_name": "MSCAP - Multi Vendor Detection - Attacked Internal IP ACC (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"user": "user", "attack": "attack", "_vendor": "vendor", "_product": "product", "filehash": "file_hash", "severity": "severity", "sourceip": "xdm.source.ipv4", "targetip": "xdm.target.ipv4", "alertaction": "action", "attackcount": "attack_count", "lasteventtime": "last_event_time", "alert_category": "category", "firsteventtime": "first_event_time", "destinationport": "dest_port", "distinctattackcount": "attack_dc"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Asia/Calcutta", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["xdm.source.ipv4", "xdm.target.ipv4"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 76, "name": "MSCAP - Microsoft Azure Security Center Tasks RAW (CCX) - Summary Gen", "severity": "SEV_030_MEDIUM", "xql_query": "// Title: MSCAP - Microsoft Azure Security Center Tasks RAW (CCX) - Summary Gen\n// Author: Sahil Sharma, ssharma7@paloaltonetworks.com\n// Datasets: msft_graph_security_alerts_raw\n// Date: 16/July/2024\n\nconfig case_sensitive = false\n| dataset = msft_graph_security_alerts_raw \n\n| filter title not in (\"Email messages containing malicious URL removed after delivery\", \n\"activity from a password-spray associated ip address\", \"activity from a tor ip address\", \"activity from an anonymous proxy\", \n\"admin triggered user compromise investigation\", \"dlp-high volume of content detected australia financial data\", \n \"failed exact data match upload\", \"form blocked due to potential phishing attempt\", \n\"form flagged and confirmed as phishing\", \"messages containing malicious entity not removed after delivery\", \n\"potential nation-state activity\", \"powerbi administrative activity\", \"ransomware activity\", \"suspicious connector activity\", \n\"suspicious email deletion activity\", \"suspicious email sending patterns detected\", \n\"suspicious inbox manipulation\", \"suspicious tenant sending patterns observed\", \n\"tenant restricted from sending email\", \"tenant restricted from sending unprovisioned email\", \"unusual volume of external file sharing\", \n \"user restricted from sharing forms and collecting responses\", \"Email reported by user as malware or phish\", \"Email reported by user as junk\", \"Email reported by user as not junk\", \"Email messages containing malicious file removed after delivery\u200b\") \n\n\n| alter userPrincipalName1 = json_extract_scalar(evidence, \"$.0.primaryAddress\"), \n        userPrincipalName2 = json_extract_scalar(evidence, \"$.0.userAccount.userPrincipalName\"), \n        accountName = json_extract_scalar(evidence, \"$.0.userAccount.accountName\")\n\n| alter userPrincipalName = coalesce(userPrincipalName1, userPrincipalName2)\n\n| comp count() as total_event, earliest(createdDateTime) as first_event_time, latest(createdDateTime) as last_event_time, values(createdDateTime) as detection_time, values(detectorId) as detection_id, values(alertWebUrl) as alert_web_url, values(id) as alertId, values(incidentId) as incidentId, values(incidentWebUrl) as incident_web_url, values(category) as category, values(mitreTechniques) as mitreTechniques, values(description) as description, values(detectionSource) as orig_sourcetype, values(status) as detection_status, values(severity) as severity, values(_vendor) as vendor, values(_product) as product,  values(accountName) as accountName by title, userPrincipalName , evidence \n\n| fields total_event, first_event_time, last_event_time, detection_time, accountName, userPrincipalName, title as signature, description, evidence , detection_status, detection_id, alertId, alert_web_url, incidentId, incident_web_url, category, mitreTechniques, orig_sourcetype, severity, vendor, product ", "is_enabled": true, "description": "Rule 50", "alert_name": "MSCAP - Microsoft Azure Security Center Tasks RAW (CCX) - Summary Gen", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"creationtime": "detection_time", "detectionurl": "alert_web_url", "lasteventtime": "last_event_time", "additionaldata": "evidence", "detectiontitle": "signature", "firsteventtime": "first_event_time", "eventdescription": "description"}, "execution_mode": "SCHEDULED", "search_window": "24 minutes", "simple_schedule": "20 minutes", "timezone": "Australia/Sydney", "crontab": "*/20 * * * *", "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["signature"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 77, "name": "A potentially malicious URL click was detected", "severity": "SEV_030_MEDIUM", "xql_query": "dataset = msft_graph_security_alerts_raw\r\n|filter title contains \"A potentially malicious URL click was detected\"", "is_enabled": true, "description": "Defender for O365 Alert - Rule 79", "alert_name": "A potentially malicious URL click was detected", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"actorid": "actorDisplayName", "comment": "comments", "severity": "severity", "threatname": "threatDisplayName", "description": "description", "detectionid": "detectorId", "resourceurl": "alertWebUrl", "incidentlink": "incidentWebUrl", "sourcestatus": "status", "lasteventtime": "lastActivityDateTime", "detectiontitle": "title", "firsteventtime": "firstActivityDateTime", "eventdescription": "evidence", "threatfamilyname": "threatFamilyName", "policyrecommendation": "recommendedActions"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["actorDisplayName", "detectionSource", "alertWebUrl", "incidentId", "detectorId", "tenantId", "classification", "id", "_id", "_id", "id", "tenantId", "detectorId", "incidentId", "alertPolicyId", "incidentWebUrl"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}, {"rule_id": 78, "name": "A user clicked through to a potentially malicious URL", "severity": "SEV_030_MEDIUM", "xql_query": "dataset = msft_graph_security_alerts_raw\r\n|filter title contains \"A user clicked through to a potentially malicious URL\"", "is_enabled": true, "description": "Defender for O365 Alert - Rule 80", "alert_name": "A user clicked through to a potentially malicious URL", "alert_category": "OTHER", "alert_type": null, "alert_description": null, "alert_domain": "DOMAIN_SECURITY", "alert_fields": {"actorid": "actorDisplayName", "comment": "comments", "severity": "severity", "threatname": "threatDisplayName", "description": "description", "detectionid": "detectorId", "resourceurl": "alertWebUrl", "incidentlink": "incidentWebUrl", "sourcestatus": "status", "lasteventtime": "lastActivityDateTime", "detectiontitle": "title", "firsteventtime": "firstActivityDateTime", "eventdescription": "evidence", "threatfamilyname": "threatFamilyName", "policyrecommendation": "recommendedActions"}, "execution_mode": "REAL_TIME", "search_window": null, "simple_schedule": null, "timezone": null, "crontab": null, "suppression_enabled": true, "suppression_duration": "6 hours", "suppression_fields": ["_id", "tenantId", "detectorId", "incidentId", "alertPolicyId", "incidentWebUrl"], "dataset": "alerts", "user_defined_severity": null, "user_defined_category": null, "mitre_defs": {}, "investigation_query_link": "", "drilldown_query_timeframe": "ALERT", "mapping_strategy": "CUSTOM", "action": "ALERTS", "lookup_mapping": []}]